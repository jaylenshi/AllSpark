# BC-ORC 任务编排 - 详细设计

> **文档版本**：v1.0 | **创建日期**：2025年2月  
> **关联文档**：[02.需求分析](02.需求分析.md)、[03.产品框架](03.产品框架.md)、[04.概要设计](04.概要设计.md)  
> **微服务名称**：orchestration-service  
> **适用对象**：研发、测试、架构评审

---

## 文档说明

本文档为 **BC-ORC 任务编排** 领域的详细设计，承接 [04.概要设计](04.概要设计.md) 3.3 节，为 orchestration-service 的研发实现提供完整技术规格。

---

## 目录

- [一、领域概述](#一领域概述)
- [二、领域边界与上下文映射](#二领域边界与上下文映射)
- [三、聚合与实体详细设计](#三聚合与实体详细设计)
- [四、领域服务与领域事件](#四领域服务与领域事件)
- [五、API 接口设计](#五api-接口设计)
- [六、数据模型与表结构](#六数据模型与表结构)
- [七、组件与模块划分](#七组件与模块划分)
- [八、上下游集成设计](#八上下游集成设计)
- [九、部署与运维](#九部署与运维)
- [十、测试要点](#十测试要点)

---

## 一、领域概述

### 1.1 职责

BC-ORC 负责**任务调度、车云/家云/工业云数据流编排、闭环效率与成本运营看板**，与 K8s、GPU、Kafka、OSS 集成，是闭环编排中枢。

### 1.2 核心能力

| 能力 | 说明 | 对应需求 ID |
|------|------|-------------|
| K8s 集成 | 任务调度至 K8s；可指定 CPU/内存/GPU | ORC-01 |
| 批处理与流式 | 批处理（定时/触发）与流式两种模式 | ORC-02 |
| 任务依赖与重试 | DAG 依赖；失败可配置重试与退避 | ORC-03 |
| 车云编排 | 按规则落盘、百倍级压缩；车端到桌面 < 10 分钟 | ORC-04 |
| 调度吞吐 | 单集群 ≥ 10,000 任务/天 | ORC-05 |
| 成本运营看板 | 闭环各环节吞吐、周期、成本；ROI 分析 | ORC-06 |

### 1.3 关联用户故事

4、5、13、28、32、41（车云编排、成本看板、Robotaxi、工业）

---

## 二、领域边界与上下文映射

### 2.1 上下游关系

```
[ BC-ING ]  DataIngestionCompleted  ──┐
                                      ├──►  BC-ORC  ──►  BC-ANN / BC-SIM / BC-OTA
[ BC-CAT ]  元数据可用               ──┘      │
                                             └──►  K8s / GPU 集群
[ BC-BHV ]  FeedbackDecisionMade  ──────────► 触发回灌编排
```

### 2.2 集成模式

| 上游/下游 | 关系 | 集成方式 |
|-----------|------|----------|
| BC-ING、BC-BHV | 上游 | 消费领域事件触发编排 |
| BC-CAT | 上游 | 查询元数据确定任务范围 |
| BC-ANN、BC-SIM | 下游 | 下发编排任务 |
| BC-OTA | 下游 | 触发 OTA 任务 |
| K8s | 外部 | Job/CronJob CRD、Operator |
| 成本核算服务 | 领域服务 | 调用获取各环节成本 |

---

## 三、聚合与实体详细设计

### 3.1 聚合：OrchestrationTask（编排任务）

| 属性 | 类型 | 说明 |
|------|------|------|
| taskId | UUID | 主键 |
| tenantId | string | 租户 ID |
| taskType | enum | ANNOTATION / SIMULATION / INGESTION / OTA |
| status | enum | PENDING / RUNNING / COMPLETED / FAILED |
| dependencies | UUID[] | 依赖任务 ID |
| resourceSpec | JSON | CPU/内存/GPU 请求 |
| k8sJobRef | string | K8s Job 名称 |
| startedAt | timestamp | 启动时间 |
| completedAt | timestamp | 完成时间 |
| retryCount | int | 重试次数 |
| errorMessage | string | 失败信息 |
| createdAt | timestamp | 创建时间 |
| updatedAt | timestamp | 更新时间 |

### 3.2 聚合：DataFlow（数据流/车云编排规则）

| 属性 | 类型 | 说明 |
|------|------|------|
| flowId | UUID | 主键 |
| tenantId | string | 租户 ID |
| name | string | 流程名称 |
| flowRule | JSON | 触发条件（接管、事故、特定路口等）|
| compressionRule | JSON | 压缩策略；目标 ≥50x |
| targetPath | string | 落盘/上传目标路径 |
| status | enum | ACTIVE / DISABLED |
| createdAt | timestamp | 创建时间 |
| updatedAt | timestamp | 更新时间 |

### 3.3 值对象：TaskDependency

| 属性 | 类型 | 说明 |
|------|------|------|
| upstreamTaskId | UUID | 上游任务 |
| downstreamTaskId | UUID | 下游任务 |
| condition | enum | ALWAYS / ON_SUCCESS |

### 3.4 状态机

**OrchestrationTask**：PENDING → RUNNING → COMPLETED / FAILED；FAILED 可重试回 PENDING

---

## 四、领域服务与领域事件

### 4.1 领域服务

| 服务 | 职责 | 输入 | 输出 |
|------|------|------|------|
| OrchestrationTaskService | 创建、调度、查询任务 | CreateTaskCommand | OrchestrationTask |
| DataFlowService | 车云编排规则 CRUD、触发 | DataFlow 配置 | — |
| CostAccountingService | 核算各环节成本；支撑看板 | 无 | 成本指标 |
| DAGEngine | DAG 解析、依赖检查、拓扑排序 | TaskGraph | 可执行任务序 |

### 4.2 领域事件

| 事件 | 触发时机 | Payload 要点 |
|------|----------|--------------|
| **OrchestrationTaskScheduled** | 任务已下发至 K8s | taskId, k8sJobRef, tenantId |
| **OrchestrationTaskCompleted** | 任务执行成功 | taskId, stats, completedAt |
| **OrchestrationTaskFailed** | 任务执行失败 | taskId, errorMessage |
| **DataFlowTriggered** | 车云规则触发（如按规则落盘后上传）| flowId, assetIds |

### 4.3 消费的外部事件

| 事件 | 来源 | 处理逻辑 |
|------|------|----------|
| DataIngestionCompleted | BC-ING | 根据规则决定是否触发标注/仿真编排 |
| FeedbackDecisionMade | BC-BHV | 触发回灌采集编排 |

---

## 五、API 接口设计

### 5.1 REST API

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /v1/orchestration-tasks | 创建编排任务 |
| GET | /v1/orchestration-tasks | 查询任务列表 |
| GET | /v1/orchestration-tasks/{taskId} | 获取任务详情 |
| POST | /v1/orchestration-tasks/{taskId}/retry | 重试失败任务 |
| POST | /v1/data-flows | 创建车云编排规则 |
| GET | /v1/data-flows | 查询规则列表 |
| GET | /v1/cost-dashboard | 成本运营看板数据 |
| GET | /v1/cost-dashboard/roi | ROI 分析 |

### 5.2 创建任务请求示例

```json
{
  "taskType": "ANNOTATION",
  "scope": { "assetIds": ["asset-1", "asset-2"] },
  "resourceSpec": { "cpu": "2", "memory": "4Gi", "gpu": 1 },
  "dependencies": ["task-xxx"],
  "retryPolicy": { "maxRetries": 3, "backoff": "exponential" }
}
```

---

## 六、数据模型与表结构

### 6.1 表：orchestration_tasks

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| task_id | UUID | PK | 主键 |
| tenant_id | VARCHAR(64) | NOT NULL, IDX | 租户 ID |
| task_type | VARCHAR(32) | NOT NULL | 任务类型 |
| status | VARCHAR(16) | NOT NULL | 状态 |
| dependencies | UUID[] | | 依赖任务 |
| resource_spec | JSONB | | 资源规格 |
| k8s_job_ref | VARCHAR(256) | | K8s Job 名 |
| started_at | TIMESTAMP | | 启动时间 |
| completed_at | TIMESTAMP | | 完成时间 |
| retry_count | INT | DEFAULT 0 | 重试次数 |
| error_message | TEXT | | 错误信息 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

### 6.2 表：data_flows

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| flow_id | UUID | PK | 主键 |
| tenant_id | VARCHAR(64) | NOT NULL | 租户 ID |
| name | VARCHAR(256) | NOT NULL | 流程名称 |
| flow_rule | JSONB | | 触发规则 |
| compression_rule | JSONB | | 压缩规则 |
| target_path | VARCHAR(1024) | | 目标路径 |
| status | VARCHAR(16) | NOT NULL | 状态 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

### 6.3 表：task_dependencies

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| upstream_task_id | UUID | PK, FK | 上游任务 |
| downstream_task_id | UUID | PK, FK | 下游任务 |
| condition | VARCHAR(16) | NOT NULL | 条件 |

---

## 七、组件与模块划分

### 7.1 模块结构

```
orchestration-service/
├── api/
├── application/
├── domain/
├── infrastructure/
│   ├── k8s/                # K8s Client、Job 下发
│   ├── persistence/
│   ├── messaging/
│   └── cost-accounting/    # 成本核算（调用各 BC 或聚合指标）
└── dag-engine/             # DAG 解析、调度逻辑
```

### 7.2 K8s 集成

- 使用 Kubernetes Client 创建 Job/CronJob
- 可选：自定义 CRD + Operator 深度集成
- 监听 Job 状态，更新 OrchestrationTask，发布事件

### 7.3 车云编排

- 车端 Agent 按 flowRule 落盘；落盘完成上报或推送事件
- ORC 接收事件，触发上传/后续编排
- 压缩在车端 Agent 完成；目标 ≥50x

---

## 八、上下游集成设计

### 8.1 消费 BC-ING 事件

- 解析 DataIngestionCompleted；根据 DataFlow 规则匹配
- 匹配则创建下游 OrchestrationTask（如标注）

### 8.2 下发任务至 BC-ANN / BC-SIM

- 方式一：REST 调用下游 BC 创建任务
- 方式二：发布事件，下游 BC 消费并创建任务
- K8s Job 可封装为调用 BC 的 Worker

### 8.3 成本核算

- 拉取 ING/CAT/ANN/SIM 各环节指标（任务数、耗时、资源消耗）
- 按配置单价核算成本；聚合后供看板 API

---

## 九、部署与运维

### 9.1 依赖

- PostgreSQL
- Kafka
- K8s API Server（需 ServiceAccount 权限）

### 9.2 资源配置

- 建议 1C/1Gi；调度密集时增加

### 9.3 监控指标

| 指标 | 类型 | 说明 |
|------|------|------|
| orchestration_tasks_total | Counter | 任务总数 |
| orchestration_tasks_completed | Counter | 完成数 |
| orchestration_tasks_failed | Counter | 失败数 |
| orchestration_tasks_per_day | Gauge | 日吞吐（≥10,000 目标）|
| data_flow_triggered_total | Counter | 车云规则触发次数 |

---

## 十、测试要点

### 10.1 功能测试

| 场景 | 验收点 | 对应需求 |
|------|--------|----------|
| K8s 任务下发 | Job 创建成功；状态同步 | ORC-01 |
| DAG 依赖 | 依赖任务完成后才执行 | ORC-03 |
| 重试 | 失败后按策略重试 | ORC-03 |
| 车云编排 | 规则触发；车端到桌面 < 10 分钟 | ORC-04 |
| 成本看板 | 各环节成本可展示；ROI 可计算 | ORC-06 |

### 10.2 性能测试

- 单集群日调度 ≥ 10,000 任务

---

## 附录：需求追溯

| 需求 ID | 本章节 |
|---------|--------|
| ORC-01 | 7.2 K8s 集成、10.1 |
| ORC-02 | 3.1 taskType、4.3 事件消费 |
| ORC-03 | 3.3 TaskDependency、6.3、7.2 DAG |
| ORC-04 | 3.2 DataFlow、7.3 车云编排 |
| ORC-05 | 9.3、10.2 |
| ORC-06 | 4.1 CostAccountingService、5.1、8.3 |
