# BC-BHV 行为分析与回灌 - 详细设计

> **文档版本**：v1.0 | **创建日期**：2025年2月  
> **关联文档**：[02.需求分析](02.需求分析.md)、[03.产品框架](03.产品框架.md)、[04.概要设计](04.概要设计.md)  
> **微服务名称**：behavior-service  
> **适用对象**：研发、测试、架构评审

---

## 文档说明

本文档为 **BC-BHV 行为分析与回灌** 领域的详细设计，承接 [04.概要设计](04.概要设计.md) 3.6 节，为 behavior-service 的研发实现提供完整技术规格。

---

## 目录

- [一、领域概述](#一领域概述)
- [二、领域边界与上下文映射](#二领域边界与上下文映射)
- [三、聚合与实体详细设计](#三聚合与实体详细设计)
- [四、领域服务与领域事件](#四领域服务与领域事件)
- [五、API 接口设计](#五api-接口设计)
- [六、数据模型与表结构](#六数据模型与表结构)
- [七、组件与模块划分](#七组件与模块划分)
- [八、上下游集成设计](#八上下游集成设计)
- [九、部署与运维](#九部署与运维)
- [十、测试要点](#十测试要点)

---

## 一、领域概述

### 1.1 职责

BC-BHV 负责**车端/产线/机器人多维时间轴对齐、根因定位（感知/决策/控制/设备）、问题样本挖掘与回灌决策**，支持视频、IMU、轨迹、PLC/传感器、感知/决策叠加。

### 1.2 核心能力

| 能力 | 说明 | 对应需求 ID |
|------|------|-------------|
| 多源时间轴对齐 | 视频、IMU、轨迹、CAN/PLC、感知、决策统一时间轴 | BHV-01 |
| 多视图联动 | 拖拽时间轴；多路视频、轨迹、波形联动 | BHV-02 |
| 感知/决策叠加 | 检测框、分割、BEV、规划路径叠加 | BHV-03 |
| 问题样本导出 | 按问题类型筛选；导出至标注或回灌 | BHV-04 |

### 1.3 关联用户故事

6、8～10、37、45、46（智驾行为回放、工业故障追溯、具身 sim-to-real）

### 1.4 行业扩展

- **工业**：PLC/传感器/执行器信号（BHV-01.1）
- **具身**：遥操作、仿真数据时间轴

---

## 二、领域边界与上下文映射

### 2.1 上下游关系

```
[ BC-CAT ]  检索行为会话数据  ──►  BC-BHV  ──►  BC-ANN (问题样本导出)
                                    │    ──►  BC-ORC (FeedbackDecisionMade 回灌)
                                    └──  前端：行为回放 UI
```

### 2.2 集成模式

| 上游/下游 | 关系 | 集成方式 |
|-----------|------|----------|
| BC-CAT | 上游 | 检索资产、元数据；按 sessionId 聚合 |
| BC-ANN | 下游 | 问题样本导出至标注任务 |
| BC-ORC | 下游 | FeedbackDecisionMade 触发回灌编排 |
| 对象存储 | 外部 | 读取视频、信号等原始数据 |

---

## 三、聚合与实体详细设计

### 3.1 聚合：BehaviorSession（行为会话）

| 属性 | 类型 | 说明 |
|------|------|------|
| sessionId | UUID | 主键 |
| tenantId | string | 租户 ID |
| behaviorSource | enum | VEHICLE / INDUSTRIAL / ROBOT |
| timeRange | JSON | {startMs, endMs} |
| dataSourceRefs | JSON | [{assetId, modality, path}] |
| createdAt | timestamp | 创建时间 |
| updatedAt | timestamp | 更新时间 |

### 3.2 聚合：ProblemSample（问题样本）

| 属性 | 类型 | 说明 |
|------|------|------|
| sampleId | UUID | 主键 |
| sessionId | UUID | 关联行为会话 |
| tenantId | string | 租户 ID |
| problemType | enum | TAKEOVER / JERK / PERCEPTION_FAIL / DECISION_ERR / DEVICE_FAULT |
| rootCauseSegment | JSON | {startMs, endMs, layer} 根因时段与层级 |
| rootCauseLayer | enum | PERCEPTION / DECISION / CONTROL / DEVICE |
| status | enum | IDENTIFIED / EXPORTED_TO_ANNOTATION / TRIGGERED_BACKFILL |
| createdAt | timestamp | 创建时间 |
| updatedAt | timestamp | 更新时间 |

### 3.3 值对象：TimeRange、DataSourceRef

- **TimeRange**：startMs, endMs
- **DataSourceRef**：assetId, modality, storagePath, syncOffsetMs（时间对齐偏移）

### 3.4 数据模态

| 模态 | 说明 | 行业 |
|------|------|------|
| video | 视频流 | 智驾、工业、具身 |
| imu | IMU 数据 | 智驾、具身 |
| trajectory | 轨迹、位姿 | 智驾、具身 |
| can | CAN/模块信号 | 智驾 |
| plc | PLC/传感器/执行器 | 工业 |
| perception | 感知输出（框、BEV）| 智驾 |
| decision | 规划、决策输出 | 智驾 |

---

## 四、领域服务与领域事件

### 4.1 领域服务

| 服务 | 职责 | 输入 | 输出 |
|------|------|------|------|
| BehaviorSessionService | 会话 CRUD、数据加载、时间轴对齐 | sessionId | BehaviorSession + 对齐后数据引用 |
| ProblemSampleService | 问题样本标记、筛选、导出 | IdentifyCommand | ProblemSample |
| FeedbackDecisionService | 回灌决策生成；驱动 ORC | ProblemSample[] | FeedbackDecision |
| TimeAlignService | 多源时间对齐；毫秒/帧级 | dataSourceRefs | 对齐后时间轴 |

### 4.2 领域事件

| 事件 | 触发时机 | Payload 要点 |
|------|----------|--------------|
| **ProblemSampleIdentified** | 用户标记问题样本 | sampleId, sessionId, problemType |
| **RootCauseLocated** | 根因定位完成 | sampleId, rootCauseLayer, rootCauseSegment |
| **FeedbackDecisionMade** | 回灌决策生成 | sampleIds[], nextIngestionScope |

### 4.3 发布至 BC-ORC

FeedbackDecisionMade 由 BC-ORC 消费，触发下一轮采集编排。

---

## 五、API 接口设计

### 5.1 REST API

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /v1/behavior-sessions | 创建行为会话（或从 CAT 资产自动聚合）|
| GET | /v1/behavior-sessions | 查询会话列表 |
| GET | /v1/behavior-sessions/{sessionId} | 获取会话详情 |
| GET | /v1/behavior-sessions/{sessionId}/aligned-data | 获取对齐后数据（供前端加载）|
| POST | /v1/problem-samples | 标记问题样本 |
| GET | /v1/problem-samples | 按条件筛选问题样本 |
| POST | /v1/problem-samples/export-to-annotation | 导出至标注 |
| POST | /v1/problem-samples/trigger-backfill | 触发回灌 |

### 5.2 对齐数据响应

返回各模态的 URL/路径、时间戳映射，供前端多视图加载与联动。

---

## 六、数据模型与表结构

### 6.1 表：behavior_sessions

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| session_id | UUID | PK | 主键 |
| tenant_id | VARCHAR(64) | NOT NULL | 租户 ID |
| behavior_source | VARCHAR(32) | NOT NULL | 来源类型 |
| time_range | JSONB | | 时间范围 |
| data_source_refs | JSONB | | 数据源引用 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

### 6.2 表：problem_samples

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| sample_id | UUID | PK | 主键 |
| session_id | UUID | FK, NOT NULL | 会话 ID |
| tenant_id | VARCHAR(64) | NOT NULL | 租户 ID |
| problem_type | VARCHAR(32) | NOT NULL | 问题类型 |
| root_cause_segment | JSONB | | 根因时段 |
| root_cause_layer | VARCHAR(32) | | 根因层级 |
| status | VARCHAR(16) | NOT NULL | 状态 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

---

## 七、组件与模块划分

### 7.1 模块结构

```
behavior-service/
├── api/
├── application/
├── domain/
├── infrastructure/
│   ├── persistence/
│   ├── storage-client/     # 读取 OSS 数据
│   └── time-aligner/       # 时间对齐逻辑
├── feedback-decision/      # 回灌决策
└── behavior-ui/            # 回放前端（React/Vue + ECharts/D3/Three.js）
```

### 7.2 时间对齐

- 多源数据时间戳映射；支持毫秒/帧级
- 对齐策略：主时间轴（如视频帧）+ 其他模态插值/采样
- 工业 PLC：采样周期映射；支持 AC 信号

### 7.3 前端能力

- 多路视频同步播放
- 轨迹 2D/3D 叠加
- 信号波形图
- 感知框、BEV、规划路径叠加
- 时间轴 scrub 拖拽；多视图联动

---

## 八、上下游集成设计

### 8.1 从 BC-CAT 检索

- 按 sessionId 或 assetIds 查询
- 构建 BehaviorSession；dataSourceRefs 指向 CAT 资产

### 8.2 导出至 BC-ANN

- 调用 ANN 创建标注任务；传入 problemSample 关联的 assetIds
- 或发布事件，ANN 消费

### 8.3 触发 BC-ORC 回灌

- 发布 FeedbackDecisionMade
- BC-ORC 消费，创建下一轮采集编排任务

---

## 九、部署与运维

### 9.1 依赖

- PostgreSQL
- 对象存储（数据读取）
- Kafka（事件发布）

### 9.2 资源配置

- 服务 1C/1Gi；前端静态资源 CDN
- 数据读取为流式，不缓存至服务端

### 9.3 监控指标

| 指标 | 类型 | 说明 |
|------|------|------|
| behavior_sessions_total | Counter | 会话总数 |
| problem_samples_identified | Counter | 问题样本数 |
| problem_samples_exported | Counter | 导出数 |
| feedback_decisions_triggered | Counter | 回灌触发数 |

---

## 十、测试要点

### 10.1 功能测试

| 场景 | 验收点 | 对应需求 |
|------|--------|----------|
| 时间轴对齐 | 多模态统一时间轴；毫秒级 | BHV-01 |
| 工业信号 | PLC/传感器支持 | BHV-01.1 |
| 多视图联动 | 拖拽时间轴联动 | BHV-02 |
| 感知/决策叠加 | 框、BEV、路径叠加 | BHV-03 |
| 问题样本导出 | 可导出至标注或回灌 | BHV-04 |

### 10.2 集成测试

- FeedbackDecisionMade → BC-ORC 能触发编排
- 导出至 ANN → 标注任务可创建

---

## 附录：需求追溯

| 需求 ID | 本章节 |
|---------|--------|
| BHV-01 | 3.4 数据模态、7.2 时间对齐、10.1 |
| BHV-02 | 7.3 前端、10.1 |
| BHV-03 | 7.3、10.1 |
| BHV-04 | 4.1 ProblemSampleService、8.2、8.3、10.1 |
