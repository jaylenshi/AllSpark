# BC-SIM 仿真与合成 - 详细设计

> **文档版本**：v1.0 | **创建日期**：2025年2月  
> **关联文档**：[02.需求分析](02.需求分析.md)、[03.产品框架](03.产品框架.md)、[04.概要设计](04.概要设计.md)  
> **微服务名称**：simulation-service  
> **适用对象**：研发、测试、架构评审

---

## 文档说明

本文档为 **BC-SIM 仿真与合成** 领域的详细设计，承接 [04.概要设计](04.概要设计.md) 3.5 节，为 simulation-service 的研发实现提供完整技术规格。

---

## 目录

- [一、领域概述](#一领域概述)
- [二、领域边界与上下文映射](#二领域边界与上下文映射)
- [三、聚合与实体详细设计](#三聚合与实体详细设计)
- [四、领域服务与领域事件](#四领域服务与领域事件)
- [五、API 接口设计](#五api-接口设计)
- [六、数据模型与表结构](#六数据模型与表结构)
- [七、组件与模块划分](#七组件与模块划分)
- [八、上下游集成设计](#八上下游集成设计)
- [九、部署与运维](#九部署与运维)
- [十、测试要点](#十测试要点)

---

## 一、领域概述

### 1.1 职责

BC-SIM 负责**驾驶仿真、具身仿真、Real2Sim、动作合成、XIL 验证**，生成仿真/合成数据，单条 ≤0.05 元，日产能 ≥5,000 条/集群。

### 1.2 核心能力

| 能力 | 说明 | 对应需求 ID |
|------|------|-------------|
| 驾驶仿真 | OpenSCENARIO/OpenDRIVE；极端场景生成 | SIM-01 |
| 具身仿真 | MuJoCo/Isaac 兼容；动作轨迹、XIL 验证 | SIM-02 |
| Real2Sim | 真实场景重建仿真或场景导入接口 | SIM-03 |
| 与标注/训练闭环 | 仿真数据可进入标注流水线 | SIM-04 |
| 成本效益 | 单条 ≤0.05 元；≥5,000 条/集群/天 | SIM-05 |

### 1.3 关联用户故事

19、20、34、35、37～39（智驾、具身）

---

## 二、领域边界与上下文映射

### 2.1 上下游关系

```
[ BC-CAT ]  场景配置        ──┐
[ BC-ORC ]  任务调度        ──┼──►  BC-SIM  ──►  BC-CAT (注册仿真数据)
                              │            ──►  BC-ANN (进入标注)
                              └──  K8s GPU
```

### 2.2 集成模式

| 上游/下游 | 关系 | 集成方式 |
|-----------|------|----------|
| BC-CAT | 上游 | 获取场景配置、资产引用 |
| BC-ORC | 上游 | 接收仿真任务调度 |
| BC-CAT | 下游 | 注册仿真产出资产 |
| BC-ANN | 下游 | 仿真数据可进入标注 |
| K8s GPU | 外部 | 仿真引擎运行 |

---

## 三、聚合与实体详细设计

### 3.1 聚合：SimulationScenario（仿真场景）

| 属性 | 类型 | 说明 |
|------|------|------|
| scenarioId | UUID | 主键 |
| tenantId | string | 租户 ID |
| scenarioType | enum | DRIVING / EMBODIMENT |
| scenarioParams | JSON | 场景参数（地图、天气、光照等）|
| actionSequence | JSON | 动作序列（具身）|
| openScenarioRef | string | OpenSCENARIO 文件路径（驾驶）|
| openDriveRef | string | OpenDRIVE 文件路径（驾驶）|
| status | enum | DRAFT / READY |
| createdAt | timestamp | 创建时间 |
| updatedAt | timestamp | 更新时间 |

### 3.2 聚合：SimulationTask（仿真任务）

| 属性 | 类型 | 说明 |
|------|------|------|
| taskId | UUID | 主键 |
| tenantId | string | 租户 ID |
| scenarioId | UUID | 场景 ID |
| outputFormat | JSON | 输出格式（图像、点云、轨迹等）|
| batchSize | int | 批次大小 |
| status | enum | PENDING / RUNNING / COMPLETED / FAILED |
| k8sJobRef | string | K8s Job 引用 |
| costPerRecord | float | 单条成本（≤0.05 目标）|
| outputAssetIds | UUID[] | 产出资产 ID |
| startedAt | timestamp | 启动时间 |
| completedAt | timestamp | 完成时间 |
| createdAt | timestamp | 创建时间 |
| updatedAt | timestamp | 更新时间 |

### 3.3 值对象：ScenarioParams、ActionSequence

- **ScenarioParams**：按行业各异；驾驶为 mapId, weather, trafficDensity 等
- **ActionSequence**：具身为 jointAngles[], timestamps[]

---

## 四、领域服务与领域事件

### 4.1 领域服务

| 服务 | 职责 | 输入 | 输出 |
|------|------|------|------|
| SimulationScenarioService | 场景 CRUD、参数校验 | Scenario 配置 | SimulationScenario |
| SimulationTaskService | 任务创建、调度、K8s Job 下发 | StartSimulationCommand | SimulationTask |
| CostTrackingService | 单条成本核算；资源复用优化 | 无 | costPerRecord |

### 4.2 领域事件

| 事件 | 触发时机 | Payload 要点 |
|------|----------|--------------|
| **SimulationTaskStarted** | 任务启动 | taskId, scenarioId, k8sJobRef |
| **SimulationDataGenerated** | 仿真数据生成 | taskId, assetIds[], outputPaths[] |
| **SimulationTaskCompleted** | 任务完成 | taskId, stats, costPerRecord |
| **SimulationTaskFailed** | 任务失败 | taskId, errorMessage |

### 4.3 发布至 BC-CAT

SimulationDataGenerated 触发 BC-CAT 注册仿真产出资产。

---

## 五、API 接口设计

### 5.1 REST API

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /v1/simulation-scenarios | 创建仿真场景 |
| GET | /v1/simulation-scenarios | 查询场景列表 |
| GET | /v1/simulation-scenarios/{scenarioId} | 获取场景详情 |
| POST | /v1/simulation-tasks | 创建仿真任务 |
| GET | /v1/simulation-tasks | 查询任务列表 |
| GET | /v1/simulation-tasks/{taskId} | 获取任务详情 |
| GET | /v1/simulation-tasks/{taskId}/outputs | 获取产出资产列表 |

### 5.2 创建任务示例

```json
{
  "scenarioId": "scenario-xxx",
  "batchSize": 100,
  "outputFormat": {
    "image": true,
    "pointCloud": true,
    "trajectory": true
  }
}
```

---

## 六、数据模型与表结构

### 6.1 表：simulation_scenarios

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| scenario_id | UUID | PK | 主键 |
| tenant_id | VARCHAR(64) | NOT NULL | 租户 ID |
| scenario_type | VARCHAR(32) | NOT NULL | 仿真类型 |
| scenario_params | JSONB | | 场景参数 |
| action_sequence | JSONB | | 动作序列 |
| open_scenario_ref | VARCHAR(1024) | | OpenSCENARIO 路径 |
| open_drive_ref | VARCHAR(1024) | | OpenDRIVE 路径 |
| status | VARCHAR(16) | NOT NULL | 状态 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

### 6.2 表：simulation_tasks

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| task_id | UUID | PK | 主键 |
| tenant_id | VARCHAR(64) | NOT NULL | 租户 ID |
| scenario_id | UUID | FK, NOT NULL | 场景 ID |
| output_format | JSONB | | 输出格式 |
| batch_size | INT | NOT NULL | 批次大小 |
| status | VARCHAR(16) | NOT NULL | 状态 |
| k8s_job_ref | VARCHAR(256) | | K8s Job |
| cost_per_record | FLOAT | | 单条成本 |
| started_at | TIMESTAMP | | 启动时间 |
| completed_at | TIMESTAMP | | 完成时间 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

### 6.3 表：simulation_task_outputs

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| task_id | UUID | PK, FK | 任务 ID |
| asset_id | UUID | PK | 产出资产 ID |
| output_path | VARCHAR(1024) | NOT NULL | 输出路径 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |

---

## 七、组件与模块划分

### 7.1 模块结构

```
simulation-service/
├── api/
├── application/
├── domain/
├── infrastructure/
│   ├── k8s/                # Job 下发
│   ├── persistence/
│   └── engine-adapter/      # 仿真引擎适配
│       ├── driving/        # OpenSCENARIO/OpenDRIVE
│       └── embodiment/     # MuJoCo/Isaac
└── cost-optimizer/         # 成本控制（资源复用、批量调度）
```

### 7.2 仿真引擎

- **驾驶**：集成或封装 OpenSCENARIO、OpenDRIVE 兼容引擎
- **具身**：MuJoCo/Isaac 或兼容；容器化运行
- **Real2Sim**：真实场景导入接口；场景转换逻辑

### 7.3 成本控制

- GPU 资源池复用；批量调度降低单条成本
- 目标：单条 ≤0.05 元；日产能 ≥5,000 条/集群

---

## 八、上下游集成设计

### 8.1 从 BC-ORC 接收任务

- 消费编排事件或 REST 调用

### 8.2 注册至 BC-CAT

- 发布 SimulationDataGenerated
- BC-CAT 消费并注册 DataAsset

### 8.3 进入 BC-ANN

- 仿真资产注册后，可通过 ORC 或用户手动创建标注任务

---

## 九、部署与运维

### 9.1 依赖

- PostgreSQL
- K8s（GPU 节点）
- 仿真引擎镜像（驾驶/具身）
- 对象存储（仿真产出）

### 9.2 资源配置

- 服务 1C/1Gi
- GPU Job 按引擎需求（如 1×A100）

### 9.3 监控指标

| 指标 | 类型 | 说明 |
|------|------|------|
| simulation_tasks_total | Counter | 任务总数 |
| simulation_records_per_day | Gauge | 日产能（≥5,000 目标）|
| simulation_cost_per_record | Gauge | 单条成本（≤0.05 目标）|

---

## 十、测试要点

### 10.1 功能测试

| 场景 | 验收点 | 对应需求 |
|------|--------|----------|
| 驾驶仿真 | OpenSCENARIO/OpenDRIVE 可运行；极端场景 | SIM-01 |
| 具身仿真 | MuJoCo/Isaac 可运行；XIL | SIM-02 |
| Real2Sim | 场景导入接口可用 | SIM-03 |
| 闭环 | 仿真产出可进入标注 | SIM-04 |
| 成本 | 单条 ≤0.05 元；日产能 ≥5,000 | SIM-05 |

### 10.2 性能测试

- 批量仿真吞吐
- 单条成本核算

---

## 附录：需求追溯

| 需求 ID | 本章节 |
|---------|--------|
| SIM-01 | 7.2 驾驶仿真、10.1 |
| SIM-02 | 7.2 具身仿真 |
| SIM-03 | 7.2 Real2Sim |
| SIM-04 | 8.3、10.1 |
| SIM-05 | 4.1 CostTracking、7.3、9.3、10.2 |
