# BC-ANN 标注与质检 - 详细设计

> **文档版本**：v1.0 | **创建日期**：2025年2月  
> **关联文档**：[02.需求分析](02.需求分析.md)、[03.产品框架](03.产品框架.md)、[04.概要设计](04.概要设计.md)  
> **微服务名称**：annotation-service  
> **适用对象**：研发、测试、架构评审

---

## 文档说明

本文档为 **BC-ANN 标注与质检** 领域的详细设计，承接 [04.概要设计](04.概要设计.md) 3.4 节，为 annotation-service 的研发实现提供完整技术规格。

---

## 目录

- [一、领域概述](#一领域概述)
- [二、领域边界与上下文映射](#二领域边界与上下文映射)
- [三、聚合与实体详细设计](#三聚合与实体详细设计)
- [四、领域服务与领域事件](#四领域服务与领域事件)
- [五、API 接口设计](#五api-接口设计)
- [六、数据模型与表结构](#六数据模型与表结构)
- [七、组件与模块划分](#七组件与模块划分)
- [八、上下游集成设计](#八上下游集成设计)
- [九、部署与运维](#九部署与运维)
- [十、测试要点](#十测试要点)

---

## 一、领域概述

### 1.1 职责

BC-ANN 负责**多模态标注（2D/3D/4D/BEV、动作序列、场景意图）、预标注+人工质检流水线**，标注结果可 API 导出至训练平台。

### 1.2 核心能力

| 能力 | 说明 | 对应需求 ID |
|------|------|-------------|
| 2D/3D 标注 | 2D 框、3D 框、多边形、分割掩码 | ANN-01 |
| 4D/时序标注 | 连续帧时序、BEV 联动 | ANN-02 |
| 预标注编排 | 云 GPU 预标注；多模型串行/并行 | ANN-03 |
| 自动化率与准确率 | 自动化率 ≥60%；准确率 ≥99.9% | ANN-04 |
| 质检流水线 | 多级质检；可配置通过阈值 | ANN-05 |
| 与训练平台对接 | API 导出 COCO/KITTI/自定义格式 | ANN-06 |

### 1.3 关联用户故事

7、15～21、26、27、28a、30、31、36、45、47、48

---

## 二、领域边界与上下文映射

### 2.1 上下游关系

```
[ BC-CAT ]  检索资产        ──►  BC-ANN  ──►  [ 训练平台 ] API 导出
[ BC-ORC ]  调度任务        ──►       │
                                      └──►  BC-CAT  LineageUpdated (AnnotationApproved)
```

### 2.2 集成模式

| 上游/下游 | 关系 | 集成方式 |
|-----------|------|----------|
| BC-CAT | 上游 | 检索资产列表 |
| BC-ORC | 上游 | 接收任务调度 |
| BC-CAT | 下游 | 标注通过后更新血缘 |
| 训练平台 | 下游 | REST API 导出 |
| K8s GPU | 外部 | 预标注 Job |

---

## 三、聚合与实体详细设计

### 3.1 聚合：AnnotationTask（标注任务）

| 属性 | 类型 | 说明 |
|------|------|------|
| taskId | UUID | 主键 |
| tenantId | string | 租户 ID |
| name | string | 任务名称 |
| scope | JSON | 资产范围 {assetIds, filter} |
| annotationType | enum | 2D_BOX / 3D_BOX / SEGMENTATION / BEV / 4D / ACTION_SEQUENCE |
| preLabelConfig | JSON | 预标注模型、串行/并行配置 |
| status | enum | DRAFT / RUNNING / PRE_LABELING / QC / COMPLETED |
| createdAt | timestamp | 创建时间 |
| updatedAt | timestamp | 更新时间 |

### 3.2 聚合：AnnotationResult（标注结果）

| 属性 | 类型 | 说明 |
|------|------|------|
| resultId | UUID | 主键 |
| taskId | UUID | 任务 ID |
| assetId | UUID | 资产 ID |
| tenantId | string | 租户 ID |
| annotations | JSON | 框、掩码、标签等 |
| qcStatus | enum | PENDING / PASSED / REJECTED |
| qcLevel | enum | INITIAL / RECHECK / SAMPLE |
| createdAt | timestamp | 创建时间 |
| updatedAt | timestamp | 更新时间 |

### 3.3 聚合：QCItem（质检单）

| 属性 | 类型 | 说明 |
|------|------|------|
| qcItemId | UUID | 主键 |
| resultId | UUID | 关联标注结果 |
| qcLevel | enum | INITIAL / RECHECK / SAMPLE |
| status | enum | PENDING / PASSED / REJECTED |
| passThreshold | float | 通过阈值（可配置）|
| reviewerId | string | 质检员 |
| reviewedAt | timestamp | 审核时间 |
| createdAt | timestamp | 创建时间 |

### 3.4 值对象：BoundingBox、Mask、Label

- **BoundingBox**：x, y, w, h（2D）或 x, y, z, w, h, d, yaw（3D）
- **Mask**：polygon 或 raster 引用
- **Label**：labelId, labelName, confidence

---

## 四、领域服务与领域事件

### 4.1 领域服务

| 服务 | 职责 | 输入 | 输出 |
|------|------|------|------|
| AnnotationTaskService | 任务 CRUD、启动预标注、进入质检 | CreateTaskCommand | AnnotationTask |
| PreLabelingService | 调度 K8s GPU Job；多模型编排 | taskId, assetIds | 预标注结果 |
| QCWorkflowService | 质检流水线；初检/复检/抽检 | ApproveCommand | QCItem |
| ExportService | 导出 COCO/KITTI/自定义 | taskId, format | 导出文件/URL |

### 4.2 领域事件

| 事件 | 触发时机 | Payload 要点 |
|------|----------|--------------|
| **AnnotationTaskCreated** | 任务创建 | taskId, scope, annotationType |
| **PreLabelingCompleted** | 预标注完成 | taskId, resultIds |
| **AnnotationApproved** | 标注通过质检 | resultId, assetId, annotations |
| **AnnotationRejected** | 标注被拒 | resultId, reason |

### 4.3 发布至 BC-CAT

AnnotationApproved 触发 BC-CAT LineageUpdated（原资产 → 标注产出资产）。

---

## 五、API 接口设计

### 5.1 REST API

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /v1/annotation-tasks | 创建标注任务 |
| GET | /v1/annotation-tasks | 查询任务列表 |
| GET | /v1/annotation-tasks/{taskId} | 获取任务详情 |
| POST | /v1/annotation-tasks/{taskId}/run-prelabeling | 执行预标注 |
| GET | /v1/annotation-tasks/{taskId}/results | 获取标注结果 |
| PUT | /v1/annotation-results/{resultId} | 更新标注（人工修正）|
| POST | /v1/annotation-results/{resultId}/approve | 通过质检 |
| POST | /v1/annotation-results/{resultId}/reject | 拒绝质检 |
| GET | /v1/annotation-tasks/{taskId}/export | 导出（format=coco|kitti|custom）|

### 5.2 导出格式

- **COCO**：instances、keypoints 等
- **KITTI**：3D 框、BEV
- **自定义**：JSON Schema 可配置

---

## 六、数据模型与表结构

### 6.1 表：annotation_tasks

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| task_id | UUID | PK | 主键 |
| tenant_id | VARCHAR(64) | NOT NULL, IDX | 租户 ID |
| name | VARCHAR(256) | NOT NULL | 任务名称 |
| scope | JSONB | | 资产范围 |
| annotation_type | VARCHAR(32) | NOT NULL | 标注类型 |
| pre_label_config | JSONB | | 预标注配置 |
| status | VARCHAR(16) | NOT NULL | 状态 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

### 6.2 表：annotation_results

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| result_id | UUID | PK | 主键 |
| task_id | UUID | FK, NOT NULL | 任务 ID |
| asset_id | UUID | NOT NULL | 资产 ID |
| tenant_id | VARCHAR(64) | NOT NULL | 租户 ID |
| annotations | JSONB | | 标注内容 |
| qc_status | VARCHAR(16) | NOT NULL | 质检状态 |
| qc_level | VARCHAR(16) | | 质检层级 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

### 6.3 表：qc_items

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| qc_item_id | UUID | PK | 主键 |
| result_id | UUID | FK, NOT NULL | 标注结果 ID |
| qc_level | VARCHAR(16) | NOT NULL | 质检层级 |
| status | VARCHAR(16) | NOT NULL | 状态 |
| pass_threshold | FLOAT | | 通过阈值 |
| reviewer_id | VARCHAR(64) | | 质检员 |
| reviewed_at | TIMESTAMP | | 审核时间 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |

---

## 七、组件与模块划分

### 7.1 模块结构

```
annotation-service/
├── api/
├── application/
├── domain/
├── infrastructure/
│   ├── prelabeling/         # K8s GPU Job 调度
│   ├── persistence/
│   └── export/              # 格式转换、导出
├── qc-workflow/             # 质检流水线引擎
└── annotation-ui/           # 前端（React/Vue）
```

### 7.2 预标注流程

1. 接收 RunPreLabeling 命令
2. 根据 preLabelConfig 创建 K8s Job（GPU）
3. Job 内调用预标注模型，写回 annotation_results
4. 发布 PreLabelingCompleted 事件
5. 自动进入质检队列

### 7.3 质检流水线

- **初检**：预标注完成后自动进入
- **复检**：初检不通过进入
- **抽检**：按比例抽检；可配置通过阈值
- 通过后发布 AnnotationApproved

---

## 八、上下游集成设计

### 8.1 从 BC-CAT 检索资产

- 调用 CAT /v1/assets 接口；按 scope 过滤

### 8.2 更新 BC-CAT 血缘

- 发布 AnnotationApproved；BC-CAT 消费并插入 lineage
- 或直接调用 CAT API 更新血缘

### 8.3 导出至训练平台

- REST GET /export?format=xxx
- 可选 Webhook 通知训练平台有新标注可用

---

## 九、部署与运维

### 9.1 依赖

- PostgreSQL
- K8s（GPU 节点用于预标注）
- 对象存储（标注结果、导出文件）

### 9.2 资源配置

- 服务建议 1C/1Gi
- GPU Job 按模型需求（如 1×A10）

### 9.3 监控指标

| 指标 | 类型 | 说明 |
|------|------|------|
| annotation_tasks_total | Counter | 任务总数 |
| prelabeling_automation_rate | Gauge | 预标注自动化率（≥60% 目标）|
| annotation_accuracy | Gauge | 质检通过准确率（≥99.9% 目标）|
| qc_queue_length | Gauge | 质检队列长度 |

---

## 十、测试要点

### 10.1 功能测试

| 场景 | 验收点 | 对应需求 |
|------|--------|----------|
| 2D/3D 标注 | 框、掩码可创建、编辑 | ANN-01 |
| 4D/BEV | 连续帧、BEV 联动 | ANN-02 |
| 预标注 | 多模型可编排；结果写入 | ANN-03 |
| 自动化率与准确率 | ≥60%、≥99.9% | ANN-04 |
| 质检流水线 | 初检/复检/抽检；可配置阈值 | ANN-05 |
| 导出 | COCO/KITTI 格式正确 | ANN-06 |

### 10.2 集成测试

- 标注通过 → BC-CAT 血缘更新
- 导出 → 训练平台可解析

---

## 附录：需求追溯

| 需求 ID | 本章节 |
|---------|--------|
| ANN-01 | 3.4 BoundingBox/Mask、6.2 annotations |
| ANN-02 | 3.1 annotationType、7.2 |
| ANN-03 | 4.1 PreLabelingService、7.2 |
| ANN-04 | 9.3 监控、10.1 |
| ANN-05 | 3.3 QCItem、4.1 QCWorkflowService、7.3 |
| ANN-06 | 4.1 ExportService、5.2、8.3 |
