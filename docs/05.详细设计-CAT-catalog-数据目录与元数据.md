# BC-CAT 数据目录与元数据 - 详细设计

> **文档版本**：v1.0 | **创建日期**：2025年2月  
> **关联文档**：[02.需求分析](02.需求分析.md)、[03.产品框架](03.产品框架.md)、[04.概要设计](04.概要设计.md)  
> **微服务名称**：catalog-service  
> **适用对象**：研发、测试、架构评审

---

## 文档说明

本文档为 **BC-CAT 数据目录与元数据** 领域的详细设计，承接 [04.概要设计](04.概要设计.md) 3.2 节，为 catalog-service 的研发实现提供完整技术规格。

---

## 目录

- [一、领域概述](#一领域概述)
- [二、领域边界与上下文映射](#二领域边界与上下文映射)
- [三、聚合与实体详细设计](#三聚合与实体详细设计)
- [四、领域服务与领域事件](#四领域服务与领域事件)
- [五、API 接口设计](#五api-接口设计)
- [六、数据模型与表结构](#六数据模型与表结构)
- [七、组件与模块划分](#七组件与模块划分)
- [八、上下游集成设计](#八上下游集成设计)
- [九、部署与运维](#九部署与运维)
- [十、测试要点](#十测试要点)

---

## 一、领域概述

### 1.1 职责

BC-CAT 负责**统一元数据管理、Omni Catalog 跨源目录、场景挖掘、血缘追踪**，为下游标注、仿真、行为分析提供数据检索与按场景/长尾筛选能力。

### 1.2 核心能力

| 能力 | 说明 | 对应需求 ID |
|------|------|-------------|
| 多模态元数据模型 | 文本、图像、视频、音频、3D/4D 至少 5 种模态 | CAT-01 |
| 跨源数据目录 | 至少 2 个数据源的统一目录视图 | CAT-02 |
| 检索性能 | 百万级 P95 < 500ms | CAT-03 |
| 血缘与溯源 | 采集→标注 lineage 追踪 | CAT-04 |
| 与框架联动 | API 与 Flink/Spark/训练框架元数据交换 | CAT-05 |
| 场景挖掘 | 挖掘场景类型、长尾标签；按场景/长尾筛选 | CAT-06 |

### 1.3 关联用户故事

8、12、29、33、41、48、50（数据工程师、算法工程师、标注项目经理等）

---

## 二、领域边界与上下文映射

### 2.1 上下游关系

```
[ BC-ING ]                    [ BC-CAT ]                    [ 下游 ]
DataIngestionCompleted  ──►   catalog-service  ──►   BC-ANN / BC-SIM / BC-BHV
                                     ▲
[ BC-ANN ]  AnnotationApproved ──────┘ LineageUpdated
[ BC-SIM ]  SimulationDataGenerated ──┘
```

### 2.2 集成模式

| 上游/下游 | 关系 | 集成方式 |
|-----------|------|----------|
| BC-ING | 上游 | 消费 DataIngestionCompleted 事件 |
| BC-ANN | 下游 + 上游 | 提供检索；接收 AnnotationApproved 更新血缘 |
| BC-SIM | 下游 + 上游 | 提供检索；接收 SimulationDataGenerated |
| BC-BHV | 下游 | 提供检索、场景筛选 |
| BC-ORC | 下游 | 提供元数据查询 |
| 训练框架 | 下游 | REST API 元数据交换 |

---

## 三、聚合与实体详细设计

### 3.1 聚合：DataAsset（数据资产）

| 属性 | 类型 | 说明 |
|------|------|------|
| assetId | UUID | 主键 |
| tenantId | string | 租户 ID |
| storagePath | string | 存储路径（OSS 等）|
| modality | enum | text / image / video / audio / 3d / 4d |
| sourceId | UUID | 来源数据源 ID |
| createdAt | timestamp | 创建时间 |
| updatedAt | timestamp | 更新时间 |

### 3.2 聚合：MetadataEntry（元数据条目）

| 属性 | 类型 | 说明 |
|------|------|------|
| entryId | UUID | 主键 |
| assetId | UUID | 关联 DataAsset |
| tenantId | string | 租户 ID |
| schema | JSON | 扩展属性；按模态各异 |
| lineageRefs | JSON | 血缘引用 [{sourceAssetId, relationType}] |
| sceneTags | string[] | 场景标签（场景挖掘产出）|
| longTailTags | string[] | 长尾标签 |
| createdAt | timestamp | 创建时间 |
| updatedAt | timestamp | 更新时间 |

**Schema 示例**（视频模态）：duration, fps, resolution, codec, frameCount

### 3.3 值对象：Lineage

| 属性 | 类型 | 说明 |
|------|------|------|
| sourceAssetId | UUID | 上游资产 |
| targetAssetId | UUID | 下游资产 |
| relationType | enum | INGESTION / ANNOTATION / SIMULATION |
| createdAt | timestamp | 关系建立时间 |

---

## 四、领域服务与领域事件

### 4.1 领域服务

| 服务 | 职责 | 输入 | 输出 |
|------|------|------|------|
| MetadataService | 资产注册、元数据 CRUD、检索 | RegisterCommand, Query | DataAsset, MetadataEntry |
| LineageService | 血缘建立、查询、追溯 | LineageRef | Lineage 图 |
| SceneMiningService | 场景挖掘、长尾标签产出 | assetIds | sceneTags, longTailTags |

### 4.2 领域事件

| 事件 | 触发时机 | Payload 要点 |
|------|----------|--------------|
| **MetadataRegistered** | 新资产注册完成 | assetId, storagePath, modality, tenantId |
| **LineageUpdated** | 血缘关系更新（如标注产出）| sourceAssetId, targetAssetId, relationType |
| **SceneMiningCompleted** | 场景挖掘完成 | assetIds, sceneTags, longTailTags |

### 4.3 消费的外部事件

| 事件 | 来源 | 处理逻辑 |
|------|------|----------|
| DataIngestionCompleted | BC-ING | 注册 DataAsset + MetadataEntry |
| AnnotationApproved | BC-ANN | 更新 Lineage |
| SimulationDataGenerated | BC-SIM | 注册仿真产出资产 |

---

## 五、API 接口设计

### 5.1 REST API

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /v1/assets | 注册资产（内部/事件驱动）|
| GET | /v1/assets | 检索资产（分页、过滤、排序）|
| GET | /v1/assets/{assetId} | 获取资产详情 |
| GET | /v1/assets/{assetId}/lineage | 获取血缘图 |
| PUT | /v1/assets/{assetId}/metadata | 更新元数据 |
| POST | /v1/scene-mining | 触发场景挖掘（异步）|
| GET | /v1/scene-mining/{jobId} | 查询场景挖掘任务状态 |

### 5.2 检索查询参数

- **filter**：modality, sourceId, sceneTags, longTailTags, timeRange
- **sort**：createdAt, fileSize
- **page**：offset, limit
- **聚合**：按 modality、sceneTags 等 group by

---

## 六、数据模型与表结构

### 6.1 表：data_assets

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| asset_id | UUID | PK | 主键 |
| tenant_id | VARCHAR(64) | NOT NULL, IDX | 租户 ID |
| storage_path | VARCHAR(1024) | NOT NULL | 存储路径 |
| modality | VARCHAR(32) | NOT NULL | 模态 |
| source_id | UUID | FK | 数据源 ID |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

### 6.2 表：metadata_entries

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| entry_id | UUID | PK | 主键 |
| asset_id | UUID | FK, UNIQUE | 资产 ID |
| tenant_id | VARCHAR(64) | NOT NULL, IDX | 租户 ID |
| schema | JSONB | | 扩展属性 |
| scene_tags | VARCHAR(64)[] | IDX | 场景标签 |
| long_tail_tags | VARCHAR(64)[] | IDX | 长尾标签 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

### 6.3 表：lineage_edges

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| source_asset_id | UUID | PK, FK | 上游资产 |
| target_asset_id | UUID | PK, FK | 下游资产 |
| relation_type | VARCHAR(32) | NOT NULL | 关系类型 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |

### 6.4 Elasticsearch 索引

- **索引名**：catalog_metadata
- **用途**：条件检索加速；百万级 P95 < 500ms
- **字段**：asset_id, tenant_id, modality, storage_path, scene_tags, long_tail_tags, schema（可检索字段）

---

## 七、组件与模块划分

### 7.1 模块结构

```
catalog-service/
├── api/                    # REST 控制器
├── application/            # 应用服务
├── domain/                 # 领域模型
├── infrastructure/
│   ├── persistence/        # PostgreSQL + ES
│   ├── messaging/          # 事件订阅
│   └── scene-mining/       # 场景挖掘（Spark/Flink 或轻量聚合）
└── scene-mining-job/       # 独立 Job（可选）
```

### 7.2 场景挖掘实现

- **轻量模式**：基于已有元数据聚合统计；规则/模型产出 sceneTags
- **重量模式**：Spark/Flink 批量分析；调用预训练场景分类模型
- **输出**：更新 metadata_entries 的 scene_tags、long_tail_tags

---

## 八、上下游集成设计

### 8.1 消费 BC-ING 事件

- **Topic**：ingestion.completed
- **逻辑**：解析 payload.assetIds、storagePaths、modality；批量注册 DataAsset + MetadataEntry

### 8.2 接收 BC-ANN 血缘更新

- **方式**：BC-ANN 发布 AnnotationApproved 或直接调用 CAT API
- **逻辑**：插入 lineage_edges；source=原资产，target=标注产出资产

### 8.3 对外检索 API

- 支持 REST；可选 GraphQL
- 与 Flink/Spark/训练框架：标准格式导出或 API 联动

---

## 九、部署与运维

### 9.1 依赖

- PostgreSQL
- Elasticsearch
- Kafka（事件消费）

### 9.2 资源配置

- 建议 1C/1Gi 起步；ES 独立部署
- 百万级索引时 ES 集群 3 节点

### 9.3 监控指标

| 指标 | 类型 | 说明 |
|------|------|------|
| catalog_assets_total | Gauge | 资产总数 |
| catalog_search_latency_p95 | Histogram | 检索 P95 延迟 |
| catalog_lineage_depth | Histogram | 血缘深度 |
| scene_mining_jobs_completed | Counter | 场景挖掘完成数 |

---

## 十、测试要点

### 10.1 功能测试

| 场景 | 验收点 | 对应需求 |
|------|--------|----------|
| 多模态注册 | 支持 5+ 模态 | CAT-01 |
| 跨源目录 | ≥2 源统一视图 | CAT-02 |
| 百万级检索 | P95 < 500ms | CAT-03 |
| 血缘追溯 | 采集→标注可追溯 | CAT-04 |
| 场景挖掘 | 产出 sceneTags、可按场景筛选 | CAT-06 |

### 10.2 性能测试

- 百万级 metadata 写入与检索
- 条件检索 + 分页压力测试

---

## 附录：需求追溯

| 需求 ID | 本章节 |
|---------|--------|
| CAT-01 | 3.1 modality、6.1 表结构 |
| CAT-02 | 2.1 上下游、7.1 模块 |
| CAT-03 | 6.4 ES 索引、9.3 监控、10.1 |
| CAT-04 | 3.3 Lineage、6.3 lineage_edges |
| CAT-05 | 5.1 API、8.3 对外 |
| CAT-06 | 4.1 SceneMiningService、7.2 场景挖掘 |
