# BC-OTA OTA 与模型部署 - 详细设计

> **文档版本**：v1.0 | **创建日期**：2025年2月  
> **关联文档**：[02.需求分析](02.需求分析.md)、[03.产品框架](03.产品框架.md)、[04.概要设计](04.概要设计.md)  
> **微服务名称**：ota-service  
> **适用对象**：研发、测试、架构评审

---

## 文档说明

本文档为 **BC-OTA OTA 与模型部署** 领域的详细设计，承接 [04.概要设计](04.概要设计.md) 3.7 节，为 ota-service 的研发实现提供完整技术规格。BC-OTA 是**闭环最后一环**，将模型/固件推送到车端、机器人、产线设备。

---

## 目录

- [一、领域概述](#一领域概述)
- [二、领域边界与上下文映射](#二领域边界与上下文映射)
- [三、聚合与实体详细设计](#三聚合与实体详细设计)
- [四、领域服务与领域事件](#四领域服务与领域事件)
- [五、API 接口设计](#五api-接口设计)
- [六、数据模型与表结构](#六数据模型与表结构)
- [七、组件与模块划分](#七组件与模块划分)
- [八、上下游集成设计](#八上下游集成设计)
- [九、部署与运维](#九部署与运维)
- [十、测试要点](#十测试要点)

---

## 一、领域概述

### 1.1 职责

BC-OTA 负责 **SOTA/FOTA/DOTA 远程推送**，支持模型/固件差分更新、灰度发布、回滚，与训练平台对接触发 OTA，支持车端、机器人、产线设备。

### 1.2 核心能力

| 能力 | 说明 | 对应需求 ID |
|------|------|-------------|
| SOTA/FOTA/DOTA | 支持至少 1 种 OTA 类型 | OTA-01 |
| 与训练平台对接 | 模型训练完成可触发 OTA；版本管理 | OTA-02 |
| 灰度与回滚 | 分批次推送；可回滚至上一版本 | OTA-03 |
| 与设备对接 | 标准协议与车端/机器人/产线通信 | OTA-04 |

### 1.3 关联用户故事

21、22、40（智驾、具身）

### 1.4 训练平台契约（G2 对齐）

**模型就绪事件**（Webhook 入参）：
```json
{
  "versionId": "v1.0.0",
  "artifactUri": "oss://bucket/model/v1.0.0",
  "artifactType": "SOTA|FOTA|DOTA",
  "grayPolicy": {
    "batchPercentages": [10, 20, 70],
    "intervalHours": 24
  },
  "targetDeviceType": "vehicle|robot|industrial"
}
```

---

## 二、领域边界与上下文映射

### 2.1 上下游关系

```
[ 训练平台 ]  模型就绪 Webhook   ──┐
[ BC-ORC ]   任务触发            ──┼──►  BC-OTA  ──►  车端/机器人/产线设备
                                  └──  闭环完成
```

### 2.2 集成模式

| 上游/下游 | 关系 | 集成方式 |
|-----------|------|----------|
| 训练平台 | 上游 | Webhook 接收模型就绪事件 |
| BC-ORC | 上游 | 可选：编排触发 OTA 任务 |
| 车端/机器人/产线 | 下游 | HTTP/OTA 协议下发；安全校验 |
| BC-GOV | 横切 | 操作审计 |

---

## 三、聚合与实体详细设计

### 3.1 聚合：ReleaseTask（发布任务）

| 属性 | 类型 | 说明 |
|------|------|------|
| taskId | UUID | 主键 |
| tenantId | string | 租户 ID |
| releaseType | enum | SOTA / FOTA / DOTA |
| versionId | string | 版本标识 |
| artifactUri | string | 制品路径（OSS 等）|
| targetDeviceType | enum | VEHICLE / ROBOT / INDUSTRIAL |
| grayPolicy | JSON | 灰度策略 |
| status | enum | DRAFT / RUNNING / COMPLETED / ROLLED_BACK |
| previousVersionId | string | 上一版本（回滚用）|
| createdAt | timestamp | 创建时间 |
| updatedAt | timestamp | 更新时间 |

### 3.2 聚合：DeploymentBatch（部署批次）

| 属性 | 类型 | 说明 |
|------|------|------|
| batchId | UUID | 主键 |
| taskId | UUID | 发布任务 ID |
| batchIndex | int | 批次序号 |
| targetDevices | JSON | 设备 ID 或筛选条件 |
| percentage | float | 本批次占比 |
| status | enum | PENDING / DEPLOYING / COMPLETED / FAILED |
| rollbackRef | UUID | 回滚时指向原版本批次 |
| startedAt | timestamp | 启动时间 |
| completedAt | timestamp | 完成时间 |
| createdAt | timestamp | 创建时间 |
| updatedAt | timestamp | 更新时间 |

### 3.3 值对象：GrayPolicy

| 属性 | 类型 | 说明 |
|------|------|------|
| batchPercentages | float[] | 每批次占比 [10, 20, 70] |
| intervalHours | int | 批次间隔（小时）|
| deviceFilter | JSON | 设备筛选条件 |

### 3.4 状态机

**ReleaseTask**：DRAFT → RUNNING → COMPLETED / ROLLED_BACK  
**DeploymentBatch**：PENDING → DEPLOYING → COMPLETED / FAILED

---

## 四、领域服务与领域事件

### 4.1 领域服务

| 服务 | 职责 | 输入 | 输出 |
|------|------|------|------|
| ReleaseTaskService | 任务 CRUD、从 Webhook 创建 | ModelReadyPayload | ReleaseTask |
| DeploymentBatchService | 批次创建、下发、状态同步 | ReleaseTask | DeploymentBatch |
| RollbackService | 回滚至上一版本 | taskId | Rollback 任务 |
| DeviceProtocolAdapter | 设备协议适配；HTTP/OTA 下发 | batchId, deviceIds | 下发结果 |

### 4.2 领域事件

| 事件 | 触发时机 | Payload 要点 |
|------|----------|--------------|
| **ReleaseTaskCreated** | 任务创建 | taskId, versionId, releaseType |
| **DeploymentBatchCompleted** | 某批次部署完成 | batchId, taskId, successCount |
| **RollbackTriggered** | 回滚触发 | taskId, previousVersionId |
| **OTAClosedLoopCompleted** | OTA 闭环完成 | taskId, versionId, totalDevices |

### 4.3 消费的外部 Webhook

- **训练平台**：POST /webhooks/model-ready
- Payload 见 1.4 契约
- 校验签名；创建 ReleaseTask + 首个 DeploymentBatch

---

## 五、API 接口设计

### 5.1 REST API

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /webhooks/model-ready | 训练平台模型就绪 Webhook |
| POST | /v1/release-tasks | 手动创建发布任务 |
| GET | /v1/release-tasks | 查询任务列表 |
| GET | /v1/release-tasks/{taskId} | 获取任务详情 |
| GET | /v1/release-tasks/{taskId}/batches | 获取批次列表 |
| POST | /v1/release-tasks/{taskId}/rollback | 触发回滚 |

### 5.2 创建任务示例

```json
{
  "releaseType": "SOTA",
  "versionId": "v1.0.0",
  "artifactUri": "oss://bucket/model/v1.0.0",
  "targetDeviceType": "vehicle",
  "grayPolicy": {
    "batchPercentages": [10, 20, 70],
    "intervalHours": 24
  }
}
```

---

## 六、数据模型与表结构

### 6.1 表：release_tasks

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| task_id | UUID | PK | 主键 |
| tenant_id | VARCHAR(64) | NOT NULL | 租户 ID |
| release_type | VARCHAR(16) | NOT NULL | 发布类型 |
| version_id | VARCHAR(128) | NOT NULL | 版本 ID |
| artifact_uri | VARCHAR(1024) | NOT NULL | 制品路径 |
| target_device_type | VARCHAR(32) | NOT NULL | 目标设备类型 |
| gray_policy | JSONB | | 灰度策略 |
| status | VARCHAR(16) | NOT NULL | 状态 |
| previous_version_id | VARCHAR(128) | | 上一版本 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

### 6.2 表：deployment_batches

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| batch_id | UUID | PK | 主键 |
| task_id | UUID | FK, NOT NULL | 任务 ID |
| batch_index | INT | NOT NULL | 批次序号 |
| target_devices | JSONB | | 目标设备 |
| percentage | FLOAT | | 占比 |
| status | VARCHAR(16) | NOT NULL | 状态 |
| rollback_ref | UUID | | 回滚引用 |
| started_at | TIMESTAMP | | 启动时间 |
| completed_at | TIMESTAMP | | 完成时间 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

---

## 七、组件与模块划分

### 7.1 模块结构

```
ota-service/
├── api/
│   └── webhooks/            # 模型就绪 Webhook
├── application/
├── domain/
├── infrastructure/
│   ├── persistence/
│   ├── device-protocol/     # 设备协议适配
│   │   ├── vehicle/         # 车端 OTA 协议
│   │   ├── robot/           # 机器人协议
│   │   └── industrial/     # 产线设备协议
│   └── artifact-fetcher/    # 从 OSS 获取制品
└── rollback-handler/
```

### 7.2 设备协议

- **车端**：OEM 专有或标准 OTA 协议；差分更新包格式
- **机器人**：HTTP 下载 + 校验
- **产线**：工业网关协议；固件下发
- **安全**：签名校验、传输加密

### 7.3 灰度执行

- 按 batchPercentages 分批选择设备
- 每批完成后等待 intervalHours
- 失败率超阈值可自动暂停

---

## 八、上下游集成设计

### 8.1 接收训练平台 Webhook

- 校验签名（HMAC 等）
- 解析 payload；创建 ReleaseTask
- 可选：回调训练平台确认接收

### 8.2 设备下发

- 从 artifactUri 拉取制品（或设备直拉）
- 按设备类型选择协议
- 记录下发结果；更新 DeploymentBatch 状态

### 8.3 责任边界（与 99 深化分析对齐）

- 本方提供：API、协议规范、版本管理、灰度策略
- 车端实现：由客户或科络达等 OTA 供应商负责
- 本方负责：与训练平台对接、任务与批次管理

---

## 九、部署与运维

### 9.1 依赖

- PostgreSQL
- 对象存储（制品）
- 设备可达网络

### 9.2 资源配置

- 服务 1C/1Gi
- Webhook 需公网可达或 VPN

### 9.3 监控指标

| 指标 | 类型 | 说明 |
|------|------|------|
| release_tasks_total | Counter | 任务总数 |
| deployment_batches_completed | Counter | 批次完成数 |
| deployment_devices_success | Counter | 设备下发成功数 |
| rollbacks_triggered | Counter | 回滚次数 |

---

## 十、测试要点

### 10.1 功能测试

| 场景 | 验收点 | 对应需求 |
|------|--------|----------|
| SOTA/FOTA/DOTA | 至少 1 种类型可用 | OTA-01 |
| 训练平台 Webhook | 接收模型就绪；创建任务 | OTA-02 |
| 灰度 | 分批推送；间隔正确 | OTA-03 |
| 回滚 | 可回滚至上一版本 | OTA-03 |
| 设备对接 | 与车端/机器人/产线通信 | OTA-04 |

### 10.2 集成测试

- 模拟训练平台 Webhook → 任务创建 → 批次执行
- 回滚流程

---

## 附录：需求追溯

| 需求 ID | 本章节 |
|---------|--------|
| OTA-01 | 3.1 releaseType、7.2 |
| OTA-02 | 1.4 契约、4.3 Webhook、8.1 |
| OTA-03 | 3.2 DeploymentBatch、7.3、10.1 |
| OTA-04 | 7.2 设备协议、8.2、10.1 |
