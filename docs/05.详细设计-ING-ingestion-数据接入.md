# BC-ING 数据接入 - 详细设计

> **文档版本**：v1.0 | **创建日期**：2025年2月  
> **关联文档**：[02.需求分析](02.需求分析.md)、[03.产品框架](03.产品框架.md)、[04.概要设计](04.概要设计.md)  
> **微服务名称**：ingestion-service  
> **适用对象**：研发、测试、架构评审

---

## 文档说明

本文档为 **BC-ING 数据接入** 领域的详细设计，承接 [04.概要设计](04.概要设计.md) 3.1 节，为 ingestion-service 的研发实现提供完整技术规格。

---

## 目录

- [一、领域概述](#一领域概述)
- [二、领域边界与上下文映射](#二领域边界与上下文映射)
- [三、聚合与实体详细设计](#三聚合与实体详细设计)
- [四、领域服务与领域事件](#四领域服务与领域事件)
- [五、API 接口设计](#五api-接口设计)
- [六、数据模型与表结构](#六数据模型与表结构)
- [七、组件与模块划分](#七组件与模块划分)
- [八、上下游集成设计](#八上下游集成设计)
- [九、部署与运维](#九部署与运维)
- [十、测试要点](#十测试要点)

---

## 一、领域概述

### 1.1 职责

BC-ING 负责**多源数据统一接入**，将采集车、量产车、仿真平台、产线、家居设备、Robotaxi 运营车等异构数据源的数据拉取或接收至平台，并触发下游元数据注册与编排。

### 1.2 核心能力

| 能力 | 说明 | 对应需求 ID |
|------|------|-------------|
| 对象存储接入 | OSS/S3/COS 列出、读取、元数据提取 | ING-01 |
| 消息队列接入 | Kafka、MQTT 订阅、消费、offset 管理 | ING-02 |
| 数据库/API 接入 | RDS 或 REST API 增量拉取 | ING-03 |
| Connector 可扩展 | 新增协议通过配置或插件完成 | ING-04 |
| 边缘 Agent | 直传/经网关双模式；压缩 ≥50x；可配置过滤规则 | ING-05 |

### 1.3 关联用户故事

11、28、32、33、43、44、49（数据工程师、工业数据工程师、边缘工程师等）

---

## 二、领域边界与上下文映射

### 2.1 上下游关系

```
[ 外部数据源 ]                    [ BC-ING ]
  OSS/Kafka/PLC/Matter     ──►    ingestion-service
  采集车/产线/家居设备                      │
                                            ▼
                              DataIngestionCompleted 事件
                                            │
                    ┌───────────────────────┼───────────────────────┐
                    ▼                       ▼                       ▼
              BC-CAT (元数据注册)     BC-ORC (触发编排)          BC-GOV (审计)
```

### 2.2 集成模式

| 上游/下游 | 关系 | 集成方式 |
|-----------|------|----------|
| 外部数据源 | 上游（数据提供方）| Connector 拉取 / 订阅 / 被动接收 |
| BC-CAT | 下游 | 发布 DataIngestionCompleted 事件 |
| BC-ORC | 下游 | 消费 DataIngestionCompleted 或由 ORC 轮询 |
| BC-GOV | 横切 | 操作触发审计 |

---

## 三、聚合与实体详细设计

### 3.1 聚合：DataSource（数据源）

| 属性 | 类型 | 说明 |
|------|------|------|
| sourceId | UUID | 主键 |
| tenantId | string | 租户 ID |
| name | string | 数据源名称 |
| protocolType | enum | OSS / S3 / COS / KAFKA / MQTT / RDS / API / PLC / MES / MATTER |
| connectorConfig | JSON | 连接配置（endpoint、credential、bucket/topic 等）|
| status | enum | ACTIVE / DISABLED / ERROR |
| createdAt | timestamp | 创建时间 |
| updatedAt | timestamp | 更新时间 |

**值对象 ConnectorConfig**（按协议各异）：
- OSS/S3/COS：endpoint, bucket, prefix, accessKey, secretKey（或 IAM）
- Kafka：bootstrapServers, topic, groupId, saslConfig
- MQTT：brokerUrl, topic, qos
- PLC/MES：gatewayUrl, plcAddress

### 3.2 聚合：IngestionTask（接入任务）

| 属性 | 类型 | 说明 |
|------|------|------|
| taskId | UUID | 主键 |
| sourceId | UUID | 关联数据源 |
| tenantId | string | 租户 ID |
| status | enum | PENDING / RUNNING / COMPLETED / FAILED |
| ingestionRule | JSON | 规则：过滤条件、目标路径、压缩策略等 |
| startedAt | timestamp | 启动时间 |
| completedAt | timestamp | 完成时间 |
| stats | JSON | 统计：文件数、字节数、失败数等 |
| errorMessage | string | 失败时错误信息 |

**值对象 IngestionRule**：
- filterCondition：按路径、时间、标签等过滤
- targetPath：落盘目标路径（OSS 路径等）
- compressionEnabled：是否压缩
- compressionTarget：目标压缩比（≥50x）

### 3.3 状态机

**IngestionTask 状态转换**：
```
PENDING ──(StartIngestion)──► RUNNING
RUNNING ──(成功)──► COMPLETED
RUNNING ──(失败)──► FAILED
FAILED ──(重试)──► PENDING
```

---

## 四、领域服务与领域事件

### 4.1 领域服务

| 服务 | 职责 | 输入 | 输出 |
|------|------|------|------|
| IngestionTaskService | 创建、启动、查询接入任务 | CreateTaskCommand, StartIngestionCommand | IngestionTask |
| DataSourceService | 数据源 CRUD、健康检查 | DataSource 实体 | — |

### 4.2 领域事件

| 事件 | 触发时机 | Payload 要点 |
|------|----------|--------------|
| **DataIngestionStarted** | StartIngestion 命令执行后 | taskId, sourceId, tenantId, startedAt |
| **DataIngestionCompleted** | 接入任务成功完成 | taskId, sourceId, tenantId, assetIds[], storagePaths[], modality, completedAt |
| **DataIngestionFailed** | 接入任务失败 | taskId, sourceId, tenantId, errorMessage, failedAt |

### 4.3 事件 Schema 示例

```json
{
  "eventId": "evt-xxx",
  "eventType": "DataIngestionCompleted",
  "timestamp": "2025-02-14T10:00:00Z",
  "tenantId": "tenant-001",
  "payload": {
    "taskId": "task-xxx",
    "sourceId": "source-xxx",
    "assetIds": ["asset-1", "asset-2"],
    "storagePaths": ["oss://bucket/path/asset-1", "oss://bucket/path/asset-2"],
    "modality": "video",
    "completedAt": "2025-02-14T10:05:00Z"
  }
}
```

---

## 五、API 接口设计

### 5.1 REST API

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /v1/datasources | 创建数据源 |
| GET | /v1/datasources | 查询数据源列表（分页、过滤）|
| GET | /v1/datasources/{sourceId} | 获取数据源详情 |
| PUT | /v1/datasources/{sourceId} | 更新数据源 |
| DELETE | /v1/datasources/{sourceId} | 删除数据源 |
| POST | /v1/ingestion-tasks | 创建接入任务 |
| POST | /v1/ingestion-tasks/{taskId}/start | 启动接入任务 |
| GET | /v1/ingestion-tasks/{taskId} | 查询任务状态 |
| GET | /v1/ingestion-tasks | 查询任务列表 |

### 5.2 请求/响应示例

**创建接入任务**：
```json
// POST /v1/ingestion-tasks
{
  "sourceId": "source-xxx",
  "ingestionRule": {
    "filterCondition": { "prefix": "2025/02/", "modality": "video" },
    "targetPath": "oss://target-bucket/ingested/",
    "compressionEnabled": true,
    "compressionTarget": 50
  }
}
```

---

## 六、数据模型与表结构

### 6.1 表：data_sources

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| source_id | UUID | PK | 主键 |
| tenant_id | VARCHAR(64) | NOT NULL, IDX | 租户 ID |
| name | VARCHAR(256) | NOT NULL | 数据源名称 |
| protocol_type | VARCHAR(32) | NOT NULL | 协议类型 |
| connector_config | JSONB | | 连接配置 |
| status | VARCHAR(16) | NOT NULL | 状态 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

### 6.2 表：ingestion_tasks

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| task_id | UUID | PK | 主键 |
| source_id | UUID | FK, NOT NULL | 数据源 ID |
| tenant_id | VARCHAR(64) | NOT NULL, IDX | 租户 ID |
| status | VARCHAR(16) | NOT NULL | 状态 |
| ingestion_rule | JSONB | | 接入规则 |
| started_at | TIMESTAMP | | 启动时间 |
| completed_at | TIMESTAMP | | 完成时间 |
| stats | JSONB | | 统计信息 |
| error_message | TEXT | | 错误信息 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

### 6.3 表：ingestion_task_assets（任务产出资产明细）

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| task_id | UUID | PK, FK | 任务 ID |
| asset_id | UUID | PK | 资产 ID（可为业务生成）|
| storage_path | VARCHAR(1024) | NOT NULL | 存储路径 |
| modality | VARCHAR(32) | | 模态 |
| file_size | BIGINT | | 文件大小 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |

---

## 七、组件与模块划分

### 7.1 模块结构

```
ingestion-service/
├── api/                    # REST 控制器
├── application/            # 应用服务、命令/查询
├── domain/                 # 领域模型
│   ├── aggregates/
│   ├── entities/
│   ├── value-objects/
│   └── events/
├── infrastructure/         # 基础设施
│   ├── connectors/          # 各协议 Connector 实现
│   │   ├── oss/
│   │   ├── kafka/
│   │   ├── mqtt/
│   │   └── ...
│   ├── persistence/        # 仓储实现
│   └── messaging/          # 事件发布
└── edge-agent/             # 边缘 Agent SDK（可独立仓库）
```

### 7.2 Connector 接口

```go
// Connector 统一接口
type Connector interface {
    ProtocolType() string
    Connect(config ConnectorConfig) error
    List(prefix string) ([]ObjectInfo, error)
    Read(path string) (io.ReadCloser, error)
    Close() error
}

// 流式 Connector（Kafka/MQTT）
type StreamingConnector interface {
    Connector
    Subscribe(topic string, handler func(msg []byte)) error
}
```

### 7.3 边缘 Agent

- **形态**：独立二进制（Rust/Go），可部署车端/工业网关
- **能力**：本地压缩、按规则过滤、直传 OSS 或经网关汇聚
- **配置**：YAML/JSON 配置；支持远程配置下发
- **指标**：暴露压缩比、吞吐、延迟等 Prometheus metrics

---

## 八、上下游集成设计

### 8.1 发布领域事件

- **目标**：Kafka Topic `ingestion.completed`
- **格式**：JSON；包含 eventId、timestamp、tenantId、payload
- **顺序**：按 tenantId + taskId 作为 partition key 保序

### 8.2 BC-CAT 消费

BC-CAT 订阅 `ingestion.completed`，解析 payload 中的 assetIds、storagePaths、modality，调用 CAT 元数据注册 API 或直接写入元数据存储。

### 8.3 BC-ORC 触发

BC-ORC 可订阅 `ingestion.completed`，根据规则决定是否触发编排任务；或由 ORC 轮询 ING 任务完成表。

---

## 九、部署与运维

### 9.1 部署形态

| 形态 | 说明 | 备注 |
|------|------|------|
| 云端微服务 | 部署于 K8s；多副本 | 主形态 |
| 边缘 Agent | 独立二进制；车端/网关 | 轻量、无 K8s 依赖 |

### 9.2 资源配置

- **CPU/内存**：建议 0.5C/512Mi 起步；Connector 并发高时增加
- **存储**：仅存元数据；数据本体存客户 OSS

### 9.3 监控指标

| 指标 | 类型 | 说明 |
|------|------|------|
| ingestion_tasks_total | Counter | 任务总数 |
| ingestion_tasks_completed | Counter | 完成数 |
| ingestion_tasks_failed | Counter | 失败数 |
| ingestion_bytes_total | Counter | 接入字节数 |
| ingestion_duration_seconds | Histogram | 任务耗时 |
| edge_agent_compression_ratio | Gauge | 边缘压缩比 |

---

## 十、测试要点

### 10.1 功能测试

| 场景 | 验收点 | 对应需求 |
|------|--------|----------|
| OSS 接入 | 可列出、读取、提取元数据 | ING-01 |
| Kafka 接入 | 订阅、消费、offset 提交 | ING-02 |
| 接入完成发布事件 | DataIngestionCompleted 含完整 payload | — |
| 边缘 Agent 压缩 | 压缩比 ≥ 50x | ING-05 |
| 新增 Connector | 通过插件注册即可使用 | ING-04 |

### 10.2 集成测试

- 接入完成 → BC-CAT 能收到并注册元数据
- 接入完成 → BC-ORC 能触发编排（若配置了规则）

### 10.3 性能测试

- 百万级元数据下，任务创建与查询 P95 < 500ms
- 单任务接入吞吐满足业务预期（按场景制定）

---

## 附录：需求追溯

| 需求 ID | 本章节 |
|---------|--------|
| ING-01 | 3.1 ConnectorConfig、7.2 Connector 接口、10.1 OSS |
| ING-02 | 7.2 StreamingConnector、10.1 Kafka |
| ING-03 | 7.2 Connector、3.1 协议类型 |
| ING-04 | 7.2 Connector 接口、10.1 新增 Connector |
| ING-05 | 7.3 边缘 Agent、10.1 压缩比 |
