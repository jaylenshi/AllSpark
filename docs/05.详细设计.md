# 泛智能数据闭环 - 系统数据流与时序设计

> **文档版本**：v1.0 | **创建日期**：2025年2月  
> **关联文档**：[02.需求分析](02.需求分析.md)、[03.产品框架](03.产品框架.md)、[04.概要设计](04.概要设计.md)  
> **适用对象**：架构师、研发、产品、测试

---

## 文档说明

本文档为**系统级数据流与时序设计**，以**表格形式时序图**动态展示系统实际运转时的数据流。承接各 BC 详细设计文档（05.详细设计-xxx），串联「数据接入 → 元数据注册 → 标注/仿真/行为分析 → 训练 → OTA 部署」的完整闭环，便于理解系统实际运转形态。

**与各 BC 详细设计的关系**：
- 本文档聚焦**跨 BC 数据流与时序**
- 各 BC 内部实现细节见 [05.详细设计-ING-ingestion-数据接入](05.详细设计-ING-ingestion-数据接入.md) 等分领域文档

**时序表表头说明**：

| 列名 | 说明 |
|------|------|
| 起点(源系统) | 发起调用或发布事件的一方；含用户、外部系统、各 BC；单系统内部行为时与终点相同 |
| 终点(目标系统) | 接收调用或消费事件的一方；单系统内部行为时为系统自身 |
| 事件/命令 | 领域事件名或命令名 |
| 相关 API | REST 路径、Kafka Topic、内部方法等 |
| API 协议 | HTTP、Kafka、gRPC、内部调用等 |
| 调用策略 | 同步 / 异步 |
| 说明(备注) | 补充说明、Payload 要点等 |

---

## 目录

- [一、闭环总览](#一闭环总览)
- [二、主流程：数据接入到元数据注册](#二主流程数据接入到元数据注册)
- [三、主流程：编排与标注流水线](#三主流程编排与标注流水线)
- [四、主流程：行为分析与回灌](#四主流程行为分析与回灌)
- [五、主流程：仿真数据生成](#五主流程仿真数据生成)
- [六、主流程：OTA 闭环](#六主流程ota-闭环)
- [七、横切：BC-GOV 合规与治理](#七横切bc-gov-合规与治理)
- [八、主流程：车云编排（边缘 Agent 模式）](#八主流程车云编排边缘-agent-模式)
- [九、主流程：场景挖掘与成本看板](#九主流程场景挖掘与成本看板)
- [十、端到端闭环时序总表](#十端到端闭环时序总表)
- [十一、完整性检查与缺口说明](#十一完整性检查与缺口说明)

---

## 一、闭环总览

### 1.1 数据流拓扑

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    外部数据源 / 设备                                       │
│   OSS/Kafka/PLC/采集车/量产车/产线/家居设备                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│  Layer 0  │ BC-ING 数据接入                                                               │
│           │ Connector 拉取/订阅 → 落盘 → DataIngestionCompleted 事件                       │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                                          │
                    ┌─────────────────────┼─────────────────────┐
                    ▼                     ▼                     ▼
┌──────────────────────────┐  ┌──────────────────────────┐  ┌──────────────────────────┐
│  BC-CAT 元数据注册        │  │  BC-ORC 任务编排           │  │  BC-GOV 审计（横切）      │
│  MetadataRegistered      │  │  DataFlowTriggered        │  │  AuditRecordCreated      │
└──────────────────────────┘  └──────────────────────────┘  └──────────────────────────┘
                    │                     │
                    │                     ├──────────────────┬──────────────────┐
                    │                     ▼                  ▼                  ▼
                    │             ┌──────────────┐    ┌──────────────┐    ┌──────────────┐
                    │             │ BC-ANN 标注  │    │ BC-SIM 仿真  │    │ BC-BHV 行为  │
                    │             │ 预标注→质检  │    │ 仿真→注册    │    │ 根因→回灌    │
                    │             └──────────────┘    └──────────────┘    └──────────────┘
                    │                     │                  │                  │
                    │                     │                  │                  │
                    │                     └──────────────────┼──────────────────┘
                    │                                        │
                    ▼                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    训练平台（外部）                                        │
│  标注导出 API / 仿真数据 → 训练 → 模型就绪 Webhook                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│  BC-OTA 模型部署                                                                          │
│  ReleaseTaskCreated → DeploymentBatchCompleted → 车端/机器人/产线设备                        │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
                                    闭环完成 / 下一轮迭代
```

### 1.2 集成顺序与依赖

| Layer | BC | 依赖 | 触发方式 |
|-------|-----|------|----------|
| 0 | BC-ING、BC-GOV | 外部数据源 | 人工/定时/事件 |
| 1 | BC-CAT、BC-ORC | BC-ING | 消费 DataIngestionCompleted |
| 2 | BC-ANN、BC-SIM | BC-CAT、BC-ORC | ORC 调度 + CAT 检索 |
| 2 | BC-BHV | BC-CAT | 人工创建会话或 CAT 检索 |
| 3 | BC-OTA | 训练平台、BC-ORC | 模型就绪 Webhook |

---

## 二、主流程：数据接入到元数据注册

**场景**：外部数据源（OSS/Kafka/采集车等）接入完成，触发元数据注册与编排。

| 序号 | 起点(源系统) | 终点(目标系统) | 事件/命令 | 相关 API | API 协议 | 调用策略 | 说明(备注) |
|:----:|-------------|----------------|-----------|----------|----------|----------|------------|
| 0 | 用户/控制台 | BC-ING | CreateDataSource | POST /v1/datasources | REST/HTTP | 同步 | 前置：配置数据源（protocolType、connectorConfig）；创建 IngestionTask 前需已有 sourceId |
| 1 | 用户/控制台 | BC-ING | CreateIngestionTask | POST /v1/ingestion-tasks | REST/HTTP | 同步 | 配置 sourceId、ingestionRule（过滤、落盘路径、压缩策略）|
| 2 | 用户/控制台 | BC-ING | StartIngestion | POST /v1/ingestion-tasks/{taskId}/start | REST/HTTP | 同步 | 启动接入任务 |
| 3 | BC-ING | BC-ING | StartIngestion 命令处理 | 内部 IngestionTaskService | 内部调用 | 同步 | 调度 Connector、更新任务状态 |
| 4 | BC-ING | BC-ING | DataIngestionStarted 发布 | Kafka Topic ingestion.started | Kafka | 异步 | taskId, sourceId, startedAt；可观测性 |
| 5 | BC-ING | 外部数据源(OSS/Kafka) | Connector 拉取/订阅 | OSS List/Read、Kafka Subscribe | OSS SDK / Kafka Client | 同步/流式 | 从外部源读取；边缘 Agent 可本地压缩 ≥50x |
| 6 | BC-ING | BC-ING | 落盘写入 | 内部写入 ingestion_task_assets | 内部调用 | 同步 | 按 targetPath 落盘至 OSS/S3/COS |
| 7 | BC-ING | BC-CAT、BC-ORC、BC-GOV | DataIngestionCompleted | Kafka Topic ingestion.completed | Kafka | 异步 | taskId, sourceId, assetIds[], storagePaths[], modality, completedAt |
| 7a | BC-ING | — | DataIngestionFailed | Kafka Topic ingestion.failed | Kafka | 异步 | 接入失败时发布；taskId, errorMessage；可触发告警、ORC 重试 |
| 8 | BC-CAT | BC-CAT | 消费 DataIngestionCompleted | Kafka Consumer 订阅 ingestion.completed | Kafka | 异步 | 解析 payload |
| 9 | BC-CAT | BC-CAT | RegisterAssets 内部执行 | 内部 MetadataService.register | 内部调用 | 同步 | 批量注册 DataAsset + MetadataEntry |
| 10 | BC-CAT | — | MetadataRegistered | Kafka Topic catalog.registered | Kafka | 异步 | assetId, storagePath, modality；供下游查询 |
| 11 | BC-ORC | BC-ORC | 消费 DataIngestionCompleted | Kafka Consumer 订阅 ingestion.completed | Kafka | 异步 | 根据 DataFlow 规则匹配 |
| 12 | BC-ORC | BC-ORC | 规则匹配与决策 | 内部 DataFlowService 匹配 | 内部调用 | 同步 | 若匹配则创建下游 OrchestrationTask（标注/仿真）|
| 13 | BC-GOV | BC-GOV | AuditRecord 写入 | 审计中间件拦截各 BC 操作 | 内部调用 | 同步 | 关键操作写入 AuditRecord |

---

## 三、主流程：编排与标注流水线

**场景**：元数据已就绪，创建标注任务 → 预标注 → 质检 → 导出至训练平台。

| 序号 | 起点(源系统) | 终点(目标系统) | 事件/命令 | 相关 API | API 协议 | 调用策略 | 说明(备注) |
|:----:|-------------|----------------|-----------|----------|----------|----------|------------|
| 1 | 标注项目经理 / BC-ORC | BC-ANN | CreateAnnotationTask | POST /v1/annotation-tasks | REST/HTTP | 同步 | scope、annotationType、preLabelConfig |
| 2 | BC-ANN | BC-CAT | QueryAssets | GET /v1/assets | REST/HTTP | 同步 | 按 scope 过滤资产列表 |
| 3 | BC-CAT | BC-ANN | 响应资产列表 | GET /v1/assets 响应 | REST/HTTP | 同步 | 返回 assetIds、metadata |
| 4 | BC-ANN | BC-ANN | AnnotationTaskCreated 发布 | Kafka Topic annotation.task-created | Kafka | 异步 | taskId, scope, annotationType；可观测性 |
| 5 | 标注项目经理 | BC-ANN | RunPreLabeling | POST /v1/annotation-tasks/{taskId}/run-prelabeling | REST/HTTP | 同步 | 触发预标注 |
| 6 | BC-ANN | BC-ANN | PreLabelingService 调度 | 内部 PreLabelingService | 内部调用 | 同步 | 创建 K8s GPU Job |
| 7 | BC-ANN | K8s | 创建 Job | K8s Job API | Kubernetes API | 同步 | 预标注模型运行 |
| 7a | K8s Job | BC-ANN | 预标注结果写回 | POST /v1/annotation-results（批量）或回调 API | REST/HTTP | 同步 | Job 完成时调用 BC-ANN API 写回 annotation_results |
| 8 | BC-ANN | BC-ANN | PreLabelingCompleted 发布 | Kafka Topic annotation.prelabel-completed | Kafka | 异步 | taskId, resultIds[] |
| 9 | BC-ANN | BC-ANN | 质检入队 | 内部 QCWorkflowService | 内部调用 | 同步 | 初检/复检/抽检队列 |
| 10 | 质检员 | BC-ANN | UpdateAnnotationResult | PUT /v1/annotation-results/{resultId} | REST/HTTP | 同步 | 可修正标注 |
| 11 | 质检员 | BC-ANN | ApproveAnnotation / RejectAnnotation | POST /v1/annotation-results/{resultId}/approve 或 reject | REST/HTTP | 同步 | 更新 qc_status |
| 12 | BC-ANN | BC-ANN | 质检通过/拒绝处理 | 内部 QCWorkflowService | 内部调用 | 同步 | 通过：触发事件；拒绝：发布 AnnotationRejected，入复检队列 |
| 12a | BC-ANN | BC-ANN | AnnotationRejected 发布 | Kafka Topic annotation.rejected | Kafka | 异步 | 质检拒绝时；resultId, reason；可触发复检或重新标注 |
| 13 | BC-ANN | BC-CAT | AnnotationApproved | Kafka Topic annotation.approved | Kafka | 异步 | resultId, assetId, annotations |
| 14 | BC-CAT | BC-CAT | 消费 AnnotationApproved | Kafka Consumer 订阅 annotation.approved | Kafka | 异步 | 更新 Lineage（原资产 → 标注产出）|
| 15 | 训练平台 / 算法工程师 | BC-ANN | ExportAnnotations | GET /v1/annotation-tasks/{taskId}/export?format=coco | REST/HTTP | 同步 | COCO/KITTI/自定义格式 |
| 16 | BC-ANN | 训练平台 | 可选 Webhook 通知 | 训练平台配置的 Webhook URL | REST/HTTP | 异步 | 标注可用通知 |

**由 BC-ORC 触发的编排路径**：

| 序号 | 起点(源系统) | 终点(目标系统) | 事件/命令 | 相关 API | API 协议 | 调用策略 | 说明(备注) |
|:----:|-------------|----------------|-----------|----------|----------|----------|------------|
| A | BC-ORC | BC-ORC | 消费 DataIngestionCompleted | Kafka Consumer 订阅 ingestion.completed | Kafka | 异步 | 规则匹配则创建 OrchestrationTask |
| B | BC-ORC | BC-ANN | CreateAnnotationTask | POST /v1/annotation-tasks 或 发布事件 | REST/HTTP 或 Kafka | 同步/异步 | taskType=ANNOTATION |
| C | BC-ORC | BC-ORC | 创建 K8s Job | K8s Job API | Kubernetes API | 同步 | 封装为调用 BC-ANN 的 Worker |
| D | BC-ANN | BC-ANN | 执行标注流水线 | 同上步骤 2～16 | — | — | 标注流水线 |

---

## 四、主流程：行为分析与回灌

**场景**：算法工程师在行为回放中标记问题样本，触发回灌采集或导出至标注。

| 序号 | 起点(源系统) | 终点(目标系统) | 事件/命令 | 相关 API | API 协议 | 调用策略 | 说明(备注) |
|:----:|-------------|----------------|-----------|----------|----------|----------|------------|
| 1 | 算法工程师 | BC-BHV | CreateBehaviorSession | POST /v1/behavior-sessions | REST/HTTP | 同步 | 或从 BC-CAT 资产自动聚合 |
| 2 | BC-BHV | BC-CAT | QueryAssets | GET /v1/assets | REST/HTTP | 同步 | 按 sessionId/assetIds 获取数据源引用 |
| 3 | BC-BHV | BC-BHV | 加载对齐数据 | GET /v1/behavior-sessions/{id}/aligned-data（内部调用 TimeAlignService）| REST/HTTP + 内部调用 | 同步 | 视频/IMU/轨迹/CAN/PLC/感知/决策；多源时间轴对齐 |
| 4 | 算法工程师 | BC-BHV | 前端回放交互 | WebSocket / HTTP 轮询 | WebSocket / HTTP | 同步/异步 | 拖拽时间轴、多视图联动；根因定位（感知/决策/控制/设备）|
| 5 | 算法工程师 | BC-BHV | IdentifyProblemSample | POST /v1/problem-samples | REST/HTTP | 同步 | problemType, rootCauseSegment |
| 6 | BC-BHV | BC-BHV | ProblemSampleIdentified 发布 | Kafka Topic behavior.problem-identified | Kafka | 异步 | sampleId, sessionId, problemType |
| 7 | 算法工程师 | BC-BHV | ExportToAnnotation | POST /v1/problem-samples/export-to-annotation | REST/HTTP | 同步 | 或选择触发回灌 |
| 8 | BC-BHV | BC-ANN | CreateAnnotationTask | POST /v1/annotation-tasks | REST/HTTP | 同步 | 传入 problemSample 关联的 assetIds |
| 9 | 算法工程师 | BC-BHV | TriggerBackfill | POST /v1/problem-samples/trigger-backfill | REST/HTTP | 同步 | 驱动下一轮采集 |
| 10 | BC-BHV | BC-BHV | FeedbackDecisionService 执行 | 内部 FeedbackDecisionService | 内部调用 | 同步 | 生成 nextIngestionScope 等 |
| 11 | BC-BHV | BC-ORC | FeedbackDecisionMade | Kafka Topic behavior.feedback-decision | Kafka | 异步 | sampleIds[], nextIngestionScope |
| 12 | BC-ORC | BC-ORC | 消费 FeedbackDecisionMade | Kafka Consumer 订阅 behavior.feedback-decision | Kafka | 异步 | 触发回灌编排 |
| 13 | BC-ORC | BC-ORC | 创建 OrchestrationTask | 内部 OrchestrationTaskService | 内部调用 | 同步 | taskType=INGESTION；nextIngestionScope 转 scope |
| 14 | BC-ORC | BC-ING | CreateIngestionTask | POST /v1/ingestion-tasks | REST/HTTP | 同步 | 按 nextIngestionScope 构造 sourceId、ingestionRule；回到「二、主流程」步骤 2 |

---

## 五、主流程：仿真数据生成

**场景**：仿真工程师配置场景，ORC 调度仿真任务，产出数据注册至 CAT、可进入标注。

| 序号 | 起点(源系统) | 终点(目标系统) | 事件/命令 | 相关 API | API 协议 | 调用策略 | 说明(备注) |
|:----:|-------------|----------------|-----------|----------|----------|----------|------------|
| 1 | 仿真工程师 | BC-SIM | CreateSimulationScenario | POST /v1/simulation-scenarios（或场景配置 API）| REST/HTTP | 同步 | scenarioType, scenarioParams |
| 2 | 仿真工程师 / BC-ORC | BC-SIM | CreateSimulationTask | POST /v1/simulation-tasks 或 Kafka 事件 | REST/HTTP 或 Kafka | 同步/异步 | scenarioId, batchSize；ORC 触发时调用 BC-SIM API |
| 3 | BC-ORC | BC-ORC | 消费 DataIngestionCompleted 或定时 | 创建 OrchestrationTask | 内部调用 | 同步 | taskType=SIMULATION；匹配规则后调用 BC-SIM |
| 4 | BC-ORC | BC-SIM | CreateSimulationTask | POST /v1/simulation-tasks | REST/HTTP | 同步 | ORC 编排触发时 |
| 5 | BC-SIM | BC-SIM | SimulationTaskService 调度 | 内部创建 K8s Job | Kubernetes API | 同步 | BC-SIM 负责 Job 下发，非 ORC 直接下发 |
| 6 | BC-SIM | BC-SIM | SimulationTask 执行 | K8s Job 内 SimulationEngine | 内部调用 | 同步 | 驾驶/具身引擎；OpenSCENARIO/OpenDRIVE 或 MuJoCo/Isaac |
| 7 | BC-SIM | BC-SIM | 产出数据写入 OSS | 内部写入对象存储 | OSS SDK | 同步 | 图像、点云、轨迹等 |
| 8 | BC-SIM | BC-CAT | SimulationDataGenerated | Kafka Topic simulation.generated | Kafka | 异步 | taskId, outputAssetIds[] |
| 9 | BC-CAT | BC-CAT | 消费 SimulationDataGenerated | Kafka Consumer 订阅 simulation.generated | Kafka | 异步 | 注册仿真产出资产 |
| 10 | BC-CAT | BC-CAT | Lineage 更新 | 内部 LineageService | 内部调用 | 同步 | 场景 → 仿真产出 |
| 11 | BC-SIM / BC-ORC | BC-ANN | 可选：创建标注任务 | POST /v1/annotation-tasks | REST/HTTP | 同步 | 仿真数据可进入 BC-ANN 标注流水线 |
| 12 | BC-ORC | BC-ORC | CostAccountingService 核算 | 内部 CostAccountingService | 内部调用 | 同步 | 单条 ≤0.05 元；日产能 ≥5,000 条目标 |

---

## 六、主流程：OTA 闭环

**场景**：训练平台训练完成，通过 Webhook 触发 OTA，灰度推送到车端/机器人/产线。

| 序号 | 起点(源系统) | 终点(目标系统) | 事件/命令 | 相关 API | API 协议 | 调用策略 | 说明(备注) |
|:----:|-------------|----------------|-----------|----------|----------|----------|------------|
| 1 | 训练平台 | BC-OTA | ModelReady Webhook | POST /webhooks/model-ready | REST/HTTP | 同步 | versionId, artifactUri, grayPolicy |
| 2 | BC-OTA | BC-OTA | 校验与创建 ReleaseTask | 内部 ReleaseTaskService | 内部调用 | 同步 | 签名校验、解析 payload |
| 3 | BC-OTA | BC-GOV | ReleaseTaskCreated | Kafka Topic ota.release-created | Kafka | 异步 | taskId, versionId, releaseType；审计 |
| 4 | BC-OTA | BC-OTA | 创建 DeploymentBatch | 内部 DeploymentBatchService | 内部调用 | 同步 | 按 grayPolicy.batchPercentages |
| 5 | BC-OTA | 车端/机器人/产线 | 第一批下发 | DeviceProtocolAdapter 调用设备协议 | HTTP/OTA 协议 | 同步/异步 | 选择 10% 设备；下载、校验、安装 |
| 6 | 车端/机器人/产线 | BC-OTA | 下发结果回调 | 设备上报状态（或轮询）| HTTP/OTA | 异步 | 成功/失败状态 |
| 7 | BC-OTA | BC-OTA | DeploymentBatchCompleted | 内部状态更新 | 内部调用 | 同步 | batchId, successCount |
| 8 | BC-OTA | BC-OTA | 等待灰度间隔 | 定时器 grayPolicy.intervalHours | 内部调度 | 异步 | 24 小时后下一批 |
| 9 | BC-OTA | 车端/机器人/产线 | 后续批次下发 | 同上步骤 5～6 | HTTP/OTA | 同步/异步 | 20%、70% 逐步放量 |
| 10 | BC-OTA | — | DeploymentBatchCompleted | Kafka Topic ota.batch-completed | Kafka | 异步 | 每批完成；可观测性 |
| 11 | BC-OTA | BC-OTA | OTAClosedLoopCompleted | 内部状态更新 | 内部调用 | 同步 | 全部设备完成 |
| 12 | BC-GOV | BC-GOV | 审计拦截 | 审计中间件拦截 OTA 操作 | 内部调用 | 同步 | ReleaseTask、批次操作记录 |
| 13 | 用户/运维 | BC-OTA | RollbackReleaseTask | POST /v1/release-tasks/{taskId}/rollback | REST/HTTP | 同步 | 回滚至 previousVersionId |

**闭环效率 KPI**（与 99 全局优化 G1 对齐）：问题样本识别 → 标注 → 训练 → OTA 端到端天数。

---

## 七、横切：BC-GOV 合规与治理

**场景**：全链路横切；审计、脱敏、多租户贯穿各 BC。

| 序号 | 起点(源系统) | 终点(目标系统) | 事件/命令 | 相关 API | API 协议 | 调用策略 | 说明(备注) |
|:----:|-------------|----------------|-----------|----------|----------|----------|------------|
| 1 | 各 BC | 各 BC | 业务操作执行 | 各 BC 的 REST API | REST/HTTP | 同步 | 租户上下文 tenantId 贯穿 |
| 2 | 各 BC | BC-GOV | 审计中间件拦截 | 中间件 AOP/Filter 拦截 | 内部调用 | 同步 | Create/Update/Delete 关键操作 |
| 3 | BC-GOV | BC-GOV | 写入 AuditRecord | 内部审计服务持久化 | 内部调用 | 同步 | operatorId, action, resourceType, resourceId, timestamp |
| 4 | BC-GOV | — | AuditRecordCreated | Kafka Topic gov.audit-created | Kafka | 异步 | 可选：供检索、导出 |
| 5 | 用户/下游 BC | BC-GOV | 脱敏规则应用 | 脱敏中间件/脱敏引擎 | 内部调用 | 同步 | 查询时脱敏；可配置规则；多级脱敏策略 |
| 6 | 各 BC | 各 BC | 多租户隔离 | 查询层强制 tenantId 过滤 | 内部调用 | 同步 | 数据隔离；RBAC 按租户 |
| 7 | 运维/管理员 | BC-GOV | DeploymentTopologyConfigured | 配置 API 或管理界面 | REST/HTTP | 同步 | 私有化/SaaS/边缘形态 |

---

## 八、主流程：车云编排（边缘 Agent 模式）

**场景**：车端/工业网关边缘 Agent 按规则本地落盘、压缩，落盘完成上报或推送事件，云端 ORC 触发上传与后续编排；车端到桌面 < 10 分钟。

| 序号 | 起点(源系统) | 终点(目标系统) | 事件/命令 | 相关 API | API 协议 | 调用策略 | 说明(备注) |
|:----:|-------------|----------------|-----------|----------|----------|----------|------------|
| 1 | 用户/数据工程师 | BC-ORC | CreateDataFlow | POST /v1/data-flows | REST/HTTP | 同步 | 配置 flowRule（触发条件：接管、事故等）、compressionRule（≥50x）、targetPath |
| 2 | BC-ORC | 车端/边缘 Agent | 规则下发 | 配置同步（OTA 或配置中心）| 配置协议 | 异步 | Agent 按 flowRule 本地落盘、压缩 |
| 3 | 车端/边缘 Agent | 车端/边缘 Agent | 本地落盘与压缩 | 内部逻辑 | 内部调用 | 同步 | 按规则过滤、压缩；目标 ≥50x |
| 4 | 车端/边缘 Agent | OSS/对象存储 | 直传或经网关上传 | OSS Put / 网关 API | OSS SDK / HTTP | 同步/异步 | 落盘完成可直传 OSS 或经网关汇聚 |
| 5 | 车端/边缘 Agent | BC-ING / BC-ORC | DataFlowTriggered 或落盘完成事件 | Kafka Topic 或 HTTP 回调 | Kafka / HTTP | 异步 | 落盘完成上报；flowId, assetIds, storagePaths |
| 6 | BC-ORC | BC-ORC | 消费 DataFlowTriggered | Kafka Consumer 或 HTTP 接收 | Kafka / HTTP | 异步 | 触发上传/后续编排 |
| 7 | BC-ORC | BC-CAT | 元数据注册 | 内部调用或发布事件 | — | — | 新数据路径触发 CAT 注册；可复用 DataIngestionCompleted 格式 |
| 8 | BC-ING | BC-CAT、BC-ORC | DataIngestionCompleted | Kafka Topic ingestion.completed | Kafka | 异步 | 若 Agent 经 ING 网关汇聚，ING 发布；否则 ORC 直接驱动 CAT |

---

## 九、主流程：场景挖掘与成本看板

**场景**：数据工程师触发场景挖掘；数据平台负责人查询成本看板。

**场景挖掘**：

| 序号 | 起点(源系统) | 终点(目标系统) | 事件/命令 | 相关 API | API 协议 | 调用策略 | 说明(备注) |
|:----:|-------------|----------------|-----------|----------|----------|----------|------------|
| 1 | 用户/算法工程师 | BC-CAT | RequestSceneMining | POST /v1/scene-mining | REST/HTTP | 同步 | 传入 assetIds 或筛选条件；返回 jobId |
| 2 | BC-CAT | BC-CAT | SceneMiningService 执行 | 内部 Spark/Flink 或 ES 聚合 | 内部调用 | 异步 | 产出 sceneTags、longTailTags |
| 3 | BC-CAT | BC-CAT | 更新 metadata_entries | 内部更新 scene_tags、long_tail_tags | 内部调用 | 同步 | 写入 PostgreSQL + ES 索引 |
| 4 | BC-CAT | — | SceneMiningCompleted | Kafka Topic catalog.scene-mining-completed | Kafka | 异步 | assetIds, sceneTags, longTailTags |
| 5 | BC-ANN / BC-ORC | BC-CAT | 按场景筛选 | GET /v1/assets?sceneTags=xxx | REST/HTTP | 同步 | 下游创建标注任务时按场景/长尾筛选 |

**成本看板**：

| 序号 | 起点(源系统) | 终点(目标系统) | 事件/命令 | 相关 API | API 协议 | 调用策略 | 说明(备注) |
|:----:|-------------|----------------|-----------|----------|----------|----------|------------|
| 1 | 数据平台负责人 | BC-ORC | QueryCostDashboard | GET /v1/cost-dashboard | REST/HTTP | 同步 | 各环节（ING/CAT/ANN/SIM）吞吐、耗时、成本 |
| 2 | BC-ORC | BC-ORC | CostAccountingService 聚合 | 内部调用各 BC 指标或拉取 | 内部调用 | 同步 | 任务数、资源消耗、单价核算 |
| 3 | BC-ORC | 用户/控制台 | 返回看板数据 | GET /v1/cost-dashboard 响应 | REST/HTTP | 同步 | ROI 分析、闭环周期 KPI |
| 4 | 数据平台负责人 | BC-ORC | QueryROI | GET /v1/cost-dashboard/roi | REST/HTTP | 同步 | ROI 分析 |

---

## 十、端到端闭环时序总表

以下表格将**问题样本 → 回灌 → 标注 → 训练 → OTA** 的完整闭环串成单一时序视图。

| 序号 | 起点(源系统) | 终点(目标系统) | 事件/命令 | 相关 API | API 协议 | 调用策略 | 说明(备注) |
|:----:|-------------|----------------|-----------|----------|----------|----------|------------|
| 1 | 算法工程师 | BC-BHV | TriggerBackfill | POST /v1/problem-samples/trigger-backfill | REST/HTTP | 同步 | 在 BHV 标记问题、触发回灌 |
| 2 | BC-BHV | BC-ORC | FeedbackDecisionMade | Kafka Topic behavior.feedback-decision | Kafka | 异步 | sampleIds[], nextIngestionScope |
| 3 | BC-ORC | BC-ING | 创建采集任务 | POST /v1/ingestion-tasks 或 Kafka | REST/HTTP 或 Kafka | 同步/异步 | OrchestrationTask(INGESTION) |
| 4 | BC-ING | BC-CAT、BC-ORC | DataIngestionCompleted | Kafka Topic ingestion.completed | Kafka | 异步 | taskId, assetIds[], modality |
| 5 | BC-CAT | BC-CAT | 注册资产 | 内部 MetadataService | 内部调用 | 同步 | MetadataRegistered |
| 6 | BC-ORC | BC-ANN | 创建标注任务 | POST /v1/annotation-tasks | REST/HTTP | 同步 | OrchestrationTask(ANNOTATION) |
| 7 | BC-ANN | BC-ANN | 预标注 → 质检 → 通过 | 见「三、编排与标注流水线」| — | — | PreLabelingCompleted → AnnotationApproved |
| 8 | BC-ANN | BC-CAT | AnnotationApproved | Kafka Topic annotation.approved | Kafka | 异步 | 更新 Lineage |
| 9 | 训练平台 | BC-ANN | ExportAnnotations | GET /v1/annotation-tasks/{taskId}/export | REST/HTTP | 同步 | COCO/KITTI 格式 |
| 10 | 训练平台 | 训练平台 | 训练模型 | 训练平台内部 | — | — | 模型产出（外部系统）|
| 11 | 训练平台 | BC-OTA | ModelReady Webhook | POST /webhooks/model-ready | REST/HTTP | 同步 | versionId, artifactUri, grayPolicy |
| 12 | BC-OTA | 车端/机器人/产线 | 灰度批次下发 | DeviceProtocolAdapter | HTTP/OTA | 同步/异步 | ReleaseTaskCreated → DeploymentBatchCompleted |
| 13 | 车端/设备 | — | 接收模型/固件 | — | — | — | OTAClosedLoopCompleted；下一轮迭代 |

**关键路径**：
- **最短路径（无回灌）**：用户创建 DataSource → CreateIngestionTask → StartIngestion → ING 拉取 → DataIngestionCompleted → CAT 注册 → 用户/ORC 创建标注任务 → ANN 预标注→质检 → Export → 训练 → OTA
- **回灌路径**：BHV(问题样本) → ORC(回灌编排) → ING(采集) → CAT → ORC → ANN → 训练 → OTA

**最短路径（无回灌）时序简表**：

| 序号 | 起点 | 终点 | 事件/命令 | 相关 API | 调用策略 | 说明 |
|:----:|------|------|-----------|----------|----------|------|
| 1 | 用户 | BC-ING | CreateDataSource | POST /v1/datasources | 同步 | 前置 |
| 2 | 用户 | BC-ING | CreateIngestionTask + StartIngestion | POST /v1/ingestion-tasks, /start | 同步 | 见「二」|
| 3 | BC-ING | BC-CAT、BC-ORC | DataIngestionCompleted | Kafka | 异步 | 见「二」|
| 4 | 用户 / BC-ORC | BC-ANN | CreateAnnotationTask | POST /v1/annotation-tasks | 同步 | 见「三」|
| 5 | BC-ANN | — | 预标注→质检→Export | 见「三」| — | — |
| 6 | 训练平台 | BC-ANN | ExportAnnotations | GET /export | 同步 | — |
| 7 | 训练平台 | BC-OTA | ModelReady Webhook | POST /webhooks/model-ready | 同步 | 见「六」|
| 8 | BC-OTA | 设备 | 灰度下发 | HTTP/OTA | 同步/异步 | — |

---

## 十一、完整性检查与缺口说明

本文档已完成对系统运转数据流的全面梳理，下表列出**完整性检查结果**与**已补充/待细化项**。

### 11.1 完整性检查清单

| 检查项 | 状态 | 说明 |
|--------|:----:|------|
| **数据接入** | ✅ | 含 DataSource 前置、Connector 拉取、DataIngestionCompleted/Failed、边缘 Agent 车云编排（八）|
| **元数据注册** | ✅ | CAT 消费事件、RegisterAssets、MetadataRegistered、Lineage 更新 |
| **标注流水线** | ✅ | 任务创建、CAT 检索、预标注 Job 写回、质检通过/拒绝、AnnotationApproved/Rejected、导出 |
| **行为与回灌** | ✅ | 会话创建、问题样本、FeedbackDecisionMade、ORC→ING 创建任务衔接 |
| **仿真数据** | ✅ | ORC→BC-SIM API（非 ORC 直建 Job）、SimulationDataGenerated、CAT 注册 |
| **OTA 闭环** | ✅ | Webhook、灰度批次、设备下发、回滚 |
| **车云编排** | ✅ | DataFlow 配置、边缘 Agent 落盘上报、DataFlowTriggered（八）|
| **场景挖掘** | ✅ | RequestSceneMining、SceneMiningCompleted、按场景筛选（九）|
| **成本看板** | ✅ | QueryCostDashboard、ROI（九）|
| **BC-GOV 横切** | ✅ | 审计、脱敏、多租户 |
| **失败与异常** | ✅ | DataIngestionFailed、AnnotationRejected |
| **无回灌最短路径** | ✅ | 十、关键路径 + 最短路径简表 |

### 11.2 与各 BC 详细设计的对应关系

| BC | 本文档覆盖 | 详细设计文档 |
|----|------------|--------------|
| BC-ING | 二、八 | [05.详细设计-ING](05.详细设计-ING-ingestion-数据接入.md) |
| BC-CAT | 二、三、四、五、九 | [05.详细设计-CAT](05.详细设计-CAT-catalog-数据目录与元数据.md) |
| BC-ORC | 二、三、四、五、八、九 | [05.详细设计-ORC](05.详细设计-ORC-orchestration-任务编排.md) |
| BC-ANN | 三、四、五 | [05.详细设计-ANN](05.详细设计-ANN-annotation-标注与质检.md) |
| BC-SIM | 五 | [05.详细设计-SIM](05.详细设计-SIM-simulation-仿真与合成.md) |
| BC-BHV | 四 | [05.详细设计-BHV](05.详细设计-BHV-behavior-行为分析与回灌.md) |
| BC-OTA | 六 | [05.详细设计-OTA](05.详细设计-OTA-ota-OTA与模型部署.md) |
| BC-GOV | 七 | [05.详细设计-GOV](05.详细设计-GOV-governance-合规与治理.md) |

### 11.3 待细化项（研发阶段补充）

| 项 | 说明 |
|----|------|
| 车云 Agent 协议 | 落盘完成上报的具体 Topic/HTTP 契约待 ORC/ING 详细设计对齐 |
| 预标注 Job 回调 | Job 写回 BC-ANN 的 API 形态（批量 REST vs 回调）待 ANN 详细设计确定 |
| 设备 OTA 回调 | 车端/机器人/产线上报下发结果的方式（轮询 vs Webhook）因设备类型而异 |
| API 网关 | 各 BC REST 是否统一经 API 网关、鉴权流程见 04 概要设计 |

---

## 附录：领域事件索引

| 事件 | 来源 BC | 消费方 | 主要用途 |
|------|---------|--------|----------|
| DataIngestionStarted | BC-ING | — | 可观测性 |
| **DataIngestionCompleted** | BC-ING | BC-CAT、BC-ORC、BC-GOV | 元数据注册、编排触发 |
| DataIngestionFailed | BC-ING | — | 告警、重试 |
| **DataFlowTriggered** | 边缘 Agent / BC-ORC | BC-ORC、BC-ING | 车云编排；落盘完成触发 |
| **MetadataRegistered** | BC-CAT | ANN/SIM/BHV 查询 | 资产可检索 |
| LineageUpdated | BC-CAT | — | 血缘追溯 |
| **SceneMiningCompleted** | BC-CAT | — | 场景标签更新；可被检索 |
| AnnotationTaskCreated | BC-ANN | — | 可观测性 |
| PreLabelingCompleted | BC-ANN | — | 入质检队列 |
| **AnnotationApproved** | BC-ANN | BC-CAT | 血缘更新 |
| AnnotationRejected | BC-ANN | — | 质检拒绝；复检队列 |
| SimulationDataGenerated | BC-SIM | BC-CAT | 仿真资产注册 |
| **FeedbackDecisionMade** | BC-BHV | BC-ORC | 回灌编排触发 |
| **ReleaseTaskCreated** | BC-OTA | BC-GOV | 审计 |
| DeploymentBatchCompleted | BC-OTA | — | 灰度进度 |
| AuditRecordCreated | BC-GOV | — | 合规审计 |

---

## 附录：详细设计文档索引

| 领域 | 文档 | 微服务 |
|------|------|--------|
| BC-ING | [05.详细设计-ING-ingestion-数据接入](05.详细设计-ING-ingestion-数据接入.md) | ingestion-service |
| BC-CAT | [05.详细设计-CAT-catalog-数据目录与元数据](05.详细设计-CAT-catalog-数据目录与元数据.md) | catalog-service |
| BC-ORC | [05.详细设计-ORC-orchestration-任务编排](05.详细设计-ORC-orchestration-任务编排.md) | orchestration-service |
| BC-ANN | [05.详细设计-ANN-annotation-标注与质检](05.详细设计-ANN-annotation-标注与质检.md) | annotation-service |
| BC-SIM | [05.详细设计-SIM-simulation-仿真与合成](05.详细设计-SIM-simulation-仿真与合成.md) | simulation-service |
| BC-BHV | [05.详细设计-BHV-behavior-行为分析与回灌](05.详细设计-BHV-behavior-行为分析与回灌.md) | behavior-service |
| BC-OTA | [05.详细设计-OTA-ota-OTA与模型部署](05.详细设计-OTA-ota-OTA与模型部署.md) | ota-service |
| BC-GOV | [05.详细设计-GOV-governance-合规与治理](05.详细设计-GOV-governance-合规与治理.md) | governance-service |
