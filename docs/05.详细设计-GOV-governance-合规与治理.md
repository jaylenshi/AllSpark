# BC-GOV 合规与治理 - 详细设计

> **文档版本**：v1.0 | **创建日期**：2025年2月  
> **关联文档**：[02.需求分析](02.需求分析.md)、[03.产品框架](03.产品框架.md)、[04.概要设计](04.概要设计.md)  
> **微服务名称**：governance-service  
> **适用对象**：研发、测试、架构评审

---

## 文档说明

本文档为 **BC-GOV 合规与治理** 领域的详细设计，承接 [04.概要设计](04.概要设计.md) 3.8 节，为 governance-service 的研发实现提供完整技术规格。BC-GOV 为**横切领域**，全链路操作触发审计，支撑多租户、脱敏、分级分类、出境备案。

---

## 目录

- [一、领域概述](#一领域概述)
- [二、领域边界与上下文映射](#二领域边界与上下文映射)
- [三、聚合与实体详细设计](#三聚合与实体详细设计)
- [四、领域服务与领域事件](#四领域服务与领域事件)
- [五、API 接口设计](#五api-接口设计)
- [六、数据模型与表结构](#六数据模型与表结构)
- [七、组件与模块划分](#七组件与模块划分)
- [八、上下游集成设计](#八上下游集成设计)
- [九、部署与运维](#九部署与运维)
- [十、测试要点](#十测试要点)

---

## 一、领域概述

### 1.1 职责

BC-GOV 负责**脱敏、审计、多租户隔离、私有化部署、数据分级分类、出境备案、政务云/信创适配**，满足《个保法》《数安法》合规要求。

### 1.2 核心能力

| 能力 | 说明 | 对应需求 ID |
|------|------|-------------|
| 脱敏 | 至少 2 种脱敏方式；可配置规则 | GOV-01 |
| 审计日志 | 关键操作全量记录；可检索、可导出 | GOV-02 |
| 多租户隔离 | 租户间零数据串扰；私有化部署 | GOV-03 |
| 数据分级分类 | 打标签；按标签访问控制 | GOV-04 |
| 出境备案 | 导出数据出境清单格式 | GOV-05 |
| 部署形态 | SaaS、私有化、边缘；政务云/信创 | GOV-06 |

### 1.3 关联用户故事

23、24、26、27a、31、42、50、51（法务、Tier1、政府）

### 1.4 可测场景（GOV-01.1）

对手机号、身份证等字段可配置脱敏规则，验证输出符合脱敏后格式。

---

## 二、领域边界与上下文映射

### 2.1 上下游关系

```
[ 全链路各 BC ]  操作发生  ──►  BC-GOV (审计、脱敏、多租户)  ──►  合规报表、出境清单
         │
         └──  横切：审计中间件、脱敏引擎、租户上下文
```

### 2.2 集成模式

| 上游/下游 | 关系 | 集成方式 |
|-----------|------|----------|
| 全链路 | 上游 | 各 BC 操作发生时上报审计；或审计中间件拦截 |
| 合规报表 | 下游 | API 查询、导出 |
| 出境备案 | 下游 | 清单格式导出 |

---

## 三、聚合与实体详细设计

### 3.1 聚合：AuditRecord（审计记录）

| 属性 | 类型 | 说明 |
|------|------|------|
| recordId | UUID | 主键 |
| tenantId | string | 租户 ID |
| operation | enum | CREATE / READ / UPDATE / DELETE / EXPORT / LOGIN |
| resourceType | string | 资源类型（asset, task, user 等）|
| resourceId | string | 资源 ID |
| actorId | string | 操作者 ID |
| actorIp | string | 操作者 IP |
| details | JSON | 扩展详情 |
| timestamp | timestamp | 操作时间 |
| createdAt | timestamp | 记录创建时间（不可篡改）|

### 3.2 聚合：DataClassification（数据分级）

| 属性 | 类型 | 说明 |
|------|------|------|
| classificationId | UUID | 主键 |
| assetId | UUID | 关联资产 |
| tenantId | string | 租户 ID |
| sensitivityLevel | enum | PUBLIC / INTERNAL / CONFIDENTIAL / RESTRICTED |
| businessCategory | string | 业务分类 |
| tags | string[] | 标签 |
| createdAt | timestamp | 创建时间 |
| updatedAt | timestamp | 更新时间 |

### 3.3 聚合：DeploymentTopology（部署拓扑）

| 属性 | 类型 | 说明 |
|------|------|------|
| topologyId | UUID | 主键 |
| tenantId | string | 租户 ID |
| topologyType | enum | SAAS / PRIVATE / EDGE |
| config | JSON | 部署配置（VPC、信创组件等）|
| status | enum | ACTIVE |
| createdAt | timestamp | 创建时间 |
| updatedAt | timestamp | 更新时间 |

### 3.4 值对象：MaskingRule

| 属性 | 类型 | 说明 |
|------|------|------|
| fieldPattern | string | 字段匹配（如 phone, idCard）|
| maskingType | enum | GENERALIZATION / ENCRYPTION / DIFFERENTIAL_PRIVACY |
| maskConfig | JSON | 脱敏参数 |

---

## 四、领域服务与领域事件

### 4.1 领域服务

| 服务 | 职责 | 输入 | 输出 |
|------|------|------|------|
| AuditService | 写入审计记录；查询、导出 | AuditEvent | AuditRecord |
| MaskingEngine | 脱敏执行；泛化、加密、差分隐私 | data, MaskingRule | 脱敏后数据 |
| DataClassificationService | 分级打标签；按标签访问控制 | assetId, classification | — |
| TenantContextService | 租户上下文；多租户隔离校验 | tenantId | 租户配置 |
| ExportComplianceService | 出境清单导出 | filter | 清单文件 |

### 4.2 领域事件

| 事件 | 触发时机 | Payload 要点 |
|------|----------|--------------|
| **AuditRecordCreated** | 关键操作发生 | recordId, operation, actorId |
| **DataClassified** | 数据打分级标签 | assetId, sensitivityLevel |
| **DeploymentTopologyConfigured** | 部署形态/多租户配置变更 | topologyId, topologyType |

### 4.3 横切集成

- **审计**：各 BC 在关键操作后调用 AuditService，或通过 AOP/中间件统一拦截
- **脱敏**：在数据导出、API 响应时调用 MaskingEngine
- **多租户**：请求入口注入 tenantId；查询强制加 tenantId 过滤

---

## 五、API 接口设计

### 5.1 REST API

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /v1/audit/records | 写入审计记录（内部/各 BC 调用）|
| GET | /v1/audit/records | 查询审计（分页、过滤）|
| GET | /v1/audit/records/export | 导出审计日志 |
| POST | /v1/masking/rules | 创建脱敏规则 |
| GET | /v1/masking/rules | 查询脱敏规则 |
| POST | /v1/masking/apply | 对数据执行脱敏（测试用）|
| PUT | /v1/classifications/{assetId} | 设置资产分级 |
| GET | /v1/classifications | 查询分级 |
| GET | /v1/export/compliance/overseas-list | 导出出境清单 |
| GET | /v1/deployment-topology | 获取部署拓扑 |
| PUT | /v1/deployment-topology | 更新部署拓扑 |

### 5.2 审计查询参数

- **filter**：operation, actorId, resourceType, timeRange
- **sort**：timestamp desc
- **page**：offset, limit

---

## 六、数据模型与表结构

### 6.1 表：audit_records

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| record_id | UUID | PK | 主键 |
| tenant_id | VARCHAR(64) | NOT NULL, IDX | 租户 ID |
| operation | VARCHAR(32) | NOT NULL | 操作类型 |
| resource_type | VARCHAR(64) | | 资源类型 |
| resource_id | VARCHAR(256) | | 资源 ID |
| actor_id | VARCHAR(64) | NOT NULL | 操作者 |
| actor_ip | VARCHAR(64) | | IP |
| details | JSONB | | 详情 |
| timestamp | TIMESTAMP | NOT NULL | 操作时间 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |

### 6.2 表：data_classifications

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| classification_id | UUID | PK | 主键 |
| asset_id | UUID | NOT NULL, IDX | 资产 ID |
| tenant_id | VARCHAR(64) | NOT NULL | 租户 ID |
| sensitivity_level | VARCHAR(32) | NOT NULL | 敏感级别 |
| business_category | VARCHAR(64) | | 业务分类 |
| tags | VARCHAR(64)[] | | 标签 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

### 6.3 表：deployment_topologies

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| topology_id | UUID | PK | 主键 |
| tenant_id | VARCHAR(64) | NOT NULL | 租户 ID |
| topology_type | VARCHAR(32) | NOT NULL | 部署类型 |
| config | JSONB | | 配置 |
| status | VARCHAR(16) | NOT NULL | 状态 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

### 6.4 表：masking_rules

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| rule_id | UUID | PK | 主键 |
| tenant_id | VARCHAR(64) | NOT NULL | 租户 ID |
| field_pattern | VARCHAR(128) | NOT NULL | 字段匹配 |
| masking_type | VARCHAR(32) | NOT NULL | 脱敏类型 |
| mask_config | JSONB | | 脱敏参数 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

---

## 七、组件与模块划分

### 7.1 模块结构

```
governance-service/
├── api/
├── application/
├── domain/
├── infrastructure/
│   ├── persistence/
│   ├── masking-engine/      # 脱敏引擎
│   │   ├── generalization/  # 泛化
│   │   ├── encryption/      # 加密
│   │   └── differential-privacy/  # 差分隐私
│   └── audit-middleware/    # 审计中间件（可独立部署）
└── export-compliance/       # 出境清单生成
```

### 7.2 脱敏引擎

- **泛化**：手机号 138****1234；身份证号保留前4后4
- **加密**：AES 等；可逆/不可逆
- **差分隐私**：加噪
- **可测场景**：手机号、身份证输入→验证输出格式

### 7.3 多租户隔离

- 所有业务表含 tenant_id；查询强制过滤
- 渗透测试验证租户间零串扰
- 私有化部署：单租户或有限多租户

### 7.4 政务云/信创

- 部署形态配置驱动
- 兼容信创数据库、中间件
- 可选组件替换

---

## 八、上下游集成设计

### 8.1 审计采集

- 方式一：各 BC 主动调用 AuditService API
- 方式二：审计中间件拦截 HTTP/gRPC
- 方式三：事件驱动（各 BC 发布操作事件，GOV 消费）

### 8.2 脱敏调用

- 数据导出前：调用 MaskingEngine
- API 响应：按字段配置脱敏
- 可配置白名单（内部管理员可见原值）

### 8.3 租户上下文

- 网关/认证层解析 JWT 或 Header，注入 tenantId
- 传递至下游服务；仓储层自动加 tenantId 过滤

---

## 九、部署与运维

### 9.1 依赖

- PostgreSQL（审计可考虑时序库/冷热分离）
- 可选：独立审计存储（不可篡改）

### 9.2 资源配置

- 服务 1C/1Gi
- 审计数据量大时独立存储扩容

### 9.3 监控指标

| 指标 | 类型 | 说明 |
|------|------|------|
| audit_records_total | Counter | 审计记录总数 |
| masking_rules_active | Gauge | 活跃脱敏规则数 |
| tenant_count | Gauge | 租户数 |
| classification_coverage | Gauge | 分级覆盖资产数 |

---

## 十、测试要点

### 10.1 功能测试

| 场景 | 验收点 | 对应需求 |
|------|--------|----------|
| 脱敏 | 至少 2 种方式；手机号/身份证可测 | GOV-01 |
| 审计 | 关键操作全量记录；可检索导出 | GOV-02 |
| 多租户 | 租户间零串扰；渗透测试 | GOV-03 |
| 分级分类 | 打标签；按标签访问控制 | GOV-04 |
| 出境清单 | 导出格式符合要求 | GOV-05 |
| 部署形态 | SaaS/私有化/边缘；信创 | GOV-06 |

### 10.2 安全测试

- 多租户数据隔离渗透
- 审计日志不可篡改验证

---

## 附录：需求追溯

| 需求 ID | 本章节 |
|---------|--------|
| GOV-01 | 3.4 MaskingRule、7.2、10.1 |
| GOV-02 | 3.1 AuditRecord、6.1、7.1、8.1、10.1 |
| GOV-03 | 7.3、8.3、10.1 |
| GOV-04 | 3.2 DataClassification、6.2、10.1 |
| GOV-05 | 4.1 ExportCompliance、5.1、10.1 |
| GOV-06 | 3.3 DeploymentTopology、7.4、10.1 |
